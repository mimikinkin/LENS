<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0a0a0a"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>LENS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ─── RESET ─────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overflow:hidden}
body{
  height:100%;overflow:hidden;
  background:#0a0a0a;color:#f0f0f0;
  font-family:'Nunito','Noto Sans JP',sans-serif;
  font-size:14px;line-height:1.5;
  -webkit-font-smoothing:antialiased;
  user-select:none;
}

/* ─── TOKENS ─────────────────────────────────────── */
:root{
  --bg:#0a0a0a;--s1:#111;--s2:#181818;--s3:#222;--s4:#2c2c2c;
  --b1:#1e1e1e;--b2:#2a2a2a;--b3:#363636;
  --t1:#f0f0f0;--t2:#a0a0a0;--t3:#555;
  --red:#c8000a;--red-a:rgba(200,0,10,.14);
  --r:10px;--rs:7px;
  --ease:cubic-bezier(.22,1,.36,1);
  --dur:180ms;
}

/* ─── SPLASH ─────────────────────────────────────── */
#splash{
  position:fixed;inset:0;z-index:9000;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;
}
#splash.out{animation:sp-out .5s var(--ease) forwards;pointer-events:none}
@keyframes sp-out{to{opacity:0;transform:scale(1.04)}}
.sp-ring{
  width:80px;height:80px;border-radius:50%;
  border:1.5px solid var(--b3);
  display:flex;align-items:center;justify-content:center;
  position:relative;margin-bottom:28px;
  animation:rot 9s linear infinite;
}
@keyframes rot{to{transform:rotate(360deg)}}
.sp-ring::before{content:'';position:absolute;inset:10px;border-radius:50%;border:1px solid var(--b2);animation:rot 6s linear infinite reverse}
.sp-ring::after{content:'';position:absolute;inset:22px;border-radius:50%;border:1px solid var(--b1)}
.sp-dot{width:11px;height:11px;background:var(--red);border-radius:50%;box-shadow:0 0 14px rgba(200,0,10,.6);animation:glow 3s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(200,0,10,.4)}50%{box-shadow:0 0 20px rgba(200,0,10,.9)}}
.sp-title{font-size:40px;font-weight:900;letter-spacing:10px;color:var(--t1);margin-bottom:6px}
.sp-sub{font-size:9.5px;font-weight:700;letter-spacing:4px;color:var(--t3);margin-bottom:44px}
.sp-cta{display:flex;align-items:center;gap:10px;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--t3);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:.3}55%{opacity:1}}
.sp-line{width:24px;height:1px;background:var(--b3)}

/* ─── APP SHELL ──────────────────────────────────── */
#app{
  display:flex;height:100%;width:100%;
  opacity:0;animation:fadein .4s .05s ease forwards;
}
@keyframes fadein{to{opacity:1}}

/* ─── LAYOUT: MOBILE (portrait / narrow) ─────────── */
/* Default: stacked layout */
#left-pane{
  display:flex;flex-direction:column;
  flex-shrink:0;
  /* mobile: full width, fixed preview */
}
#right-pane{
  display:flex;flex-direction:column;
  flex:1;min-width:0;overflow:hidden;
}

/* mobile stacked */
@media(max-width:767px){
  #app{flex-direction:column}
  #left-pane{width:100%}
  #preview-area{height:min(52vw,240px)}
  .panel{max-height:calc(100dvh - 330px)}
}

/* desktop side-by-side */
@media(min-width:768px){
  #app{flex-direction:row}
  #left-pane{
    width:clamp(300px,38%,420px);
    border-right:1px solid var(--b1);
  }
  #preview-area{flex:1;min-height:0}
  .tabs{
    flex-direction:column;width:58px;flex-shrink:0;
    border-right:1px solid var(--b1);border-bottom:none;
  }
  .tab{
    padding:14px 4px;min-height:62px;
    border-bottom:none;border-right:2.5px solid transparent;
  }
  .tab.active{border-right-color:var(--red);border-bottom-color:transparent}
  #editor-area{display:flex;flex:1;min-height:0;overflow:hidden}
  .panel-wrap{flex:1}
  .panel{max-height:100%}
}

/* ─── HEADER ─────────────────────────────────────── */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 16px 9px 28px;border-bottom:1px solid var(--b1);
  background:var(--bg);flex-shrink:0;gap:8px;
}
.logo{display:flex;align-items:center;gap:9px;flex-shrink:0}
.hdr-dot{width:8px;height:8px;background:var(--red);border-radius:50%;animation:glow 3s ease-in-out infinite;flex-shrink:0}
.logo-n{font-size:20px;font-weight:900;letter-spacing:3px;line-height:1}
.logo-s{font-size:8px;font-weight:700;letter-spacing:3px;color:var(--t3);margin-top:1px}
.hdr-r{display:flex;gap:6px;align-items:center;flex-wrap:nowrap}
.hbtn{
  background:var(--s2);border:1.5px solid var(--b2);color:var(--t2);
  font-family:inherit;font-size:10.5px;font-weight:700;letter-spacing:.6px;
  padding:6px 11px;cursor:pointer;border-radius:var(--rs);
  transition:border-color var(--dur),color var(--dur),background var(--dur);white-space:nowrap;
}
.hbtn:hover{border-color:var(--t3);color:var(--t1)}
.hbtn.red{background:var(--red);color:#fff;border-color:var(--red)}
.hbtn.red:hover{opacity:.88}

/* ─── PREVIEW ────────────────────────────────────── */
#preview-area{
  background:var(--s1);
  display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
  flex-shrink:0;
  border-bottom:1px solid var(--b1);
  cursor:pointer;
}
#preview-area.has-img{cursor:default}
/* checkerboard bg (transparent preview) */
#checker-bg{
  position:absolute;inset:0;display:none;
  background-image:
    linear-gradient(45deg,#1e1e1e 25%,transparent 25%),
    linear-gradient(-45deg,#1e1e1e 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#1e1e1e 75%),
    linear-gradient(-45deg,transparent 75%,#1e1e1e 75%);
  background-size:14px 14px;
  background-position:0 0,0 7px,7px -7px,-7px 0px;
  pointer-events:none;
}
#preview-canvas{
  display:none;max-width:100%;max-height:100%;
  object-fit:contain;image-rendering:auto;
  will-change:auto;
}
.ph-wrap{display:flex;flex-direction:column;align-items:center;pointer-events:none}
.ph-ring{
  width:54px;height:54px;border:1.5px solid var(--b3);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  position:relative;margin-bottom:12px;
}
.ph-ring::before{content:'';position:absolute;inset:8px;border:1px solid var(--b2);border-radius:50%}
.ph-ring::after{content:'';position:absolute;inset:17px;border:1px solid var(--b2);border-radius:50%}
.ph-dot{width:6px;height:6px;background:var(--red);border-radius:50%}
.ph-txt{font-size:10px;font-weight:700;letter-spacing:2.5px;color:var(--t3)}
/* exposure bar */
.exp-bar{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--b1)}
.exp-fill{height:100%;background:var(--red);width:50%;transition:width .1s linear}

/* ─── TABS ───────────────────────────────────────── */
.tabs{
  display:flex;background:var(--bg);
  border-bottom:1px solid var(--b1);flex-shrink:0;
}
.tab{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:9px 2px 7px;border:none;background:none;
  color:var(--t3);font-family:inherit;font-size:8px;font-weight:700;
  letter-spacing:.5px;cursor:pointer;gap:3px;
  border-bottom:2px solid transparent;
  transition:color var(--dur),border-color var(--dur);will-change:color;
}
.tab.active{color:var(--t1);border-bottom-color:var(--red)}
.tab svg{width:14px;height:14px;opacity:.6;transition:opacity var(--dur)}
.tab.active svg{opacity:1}
.tab-lbl{font-size:7.5px}

/* ─── PANEL WRAP ─────────────────────────────────── */
.panel-wrap{flex:1;overflow:hidden;min-height:0;position:relative}
.panel{
  display:none;
  padding:14px 16px 32px;
  overflow-y:auto;height:100%;
  /* GPU-accelerated scroll */
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  contain:paint layout;
}
.panel.active{display:block;animation:panel-in .2s var(--ease)}
@keyframes panel-in{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.pnl-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.pnl-title{font-size:9px;font-weight:800;letter-spacing:3px;color:var(--t3)}

/* ─── SLIDER SECTION ─────────────────────────────── */
.sl-section{margin-bottom:2px}
.sl-section-hd{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 0 8px;border-bottom:1px solid var(--b1);margin-bottom:10px;
}
.sl-section-hd.clickable{cursor:pointer}
.sl-section-hd.clickable:hover .sl-sec-title{color:var(--t2)}
.sl-sec-title{
  display:flex;align-items:center;gap:7px;
  font-size:8.5px;font-weight:800;letter-spacing:2.5px;color:var(--t3);
  transition:color var(--dur);
}
.sl-sec-bar{width:3px;height:10px;background:var(--red);border-radius:2px;flex-shrink:0}
.sl-sec-arrow{font-size:10px;color:var(--t3);transition:transform .22s var(--ease)}
.sl-section.collapsed .sl-sec-arrow{transform:rotate(-90deg)}
.sl-section-body{overflow:hidden;transition:max-height .28s var(--ease),opacity .22s ease;max-height:3000px;opacity:1}
.sl-section.collapsed .sl-section-body{max-height:0;opacity:0}

/* ─── SLIDER ROW ─────────────────────────────────── */
.sl-row{margin-bottom:15px;contain:layout style}
.sl-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.sl-label{font-size:11.5px;font-weight:700;color:var(--t2)}

/* value badge – tap to edit */
.sl-badge{
  position:relative;display:inline-flex;align-items:center;
  min-width:44px;justify-content:flex-end;
}
.sl-num{
  font-size:12px;font-weight:800;color:var(--t3);
  font-variant-numeric:tabular-nums;
  cursor:pointer;padding:2px 5px;border-radius:5px;
  transition:color .15s,background .15s;
}
.sl-num.nonzero{color:var(--red)}
.sl-num:hover{background:var(--s2)}
.sl-input{
  position:absolute;right:0;top:-3px;
  width:58px;height:24px;
  background:var(--s2);border:1.5px solid var(--red);
  color:var(--t1);font-family:inherit;font-size:12px;font-weight:800;
  text-align:right;padding:0 6px;border-radius:5px;
  outline:none;display:none;
  font-variant-numeric:tabular-nums;z-index:20;
}

/* ─── TRACK ──────────────────────────────────────── */
/* Outer hit area – 40px tall for easy touch */
.sl-track-hit{
  position:relative;height:36px;
  display:flex;align-items:center;
  touch-action:none;cursor:ew-resize;
}
.sl-track-bg{
  position:absolute;left:0;right:0;
  height:3px;background:var(--s3);border-radius:2px;pointer-events:none;
}
.sl-fill{
  position:absolute;height:3px;background:var(--red);
  border-radius:2px;pointer-events:none;
  /* NO transition – updated directly via style for 0 lag */
}
.sl-center{
  position:absolute;left:50%;top:0;
  width:1px;height:3px;background:var(--b3);
  transform:translateX(-50%);pointer-events:none;
}
.sl-thumb{
  position:absolute;
  width:17px;height:17px;
  background:var(--bg);border:2.5px solid var(--red);
  border-radius:50%;
  transform:translate(-50%,-50%);top:50%;
  pointer-events:none;
  box-shadow:0 2px 8px rgba(0,0,0,.55);
  /* NO transition on left – set directly */
  will-change:left;
}
/* when dragging: glow ring via class added by JS */
.sl-track-hit.active .sl-thumb{
  border-color:var(--red);
  box-shadow:0 0 0 6px var(--red-a),0 2px 8px rgba(0,0,0,.5);
  transform:translate(-50%,-50%) scale(1.08);
  transition:transform .12s var(--ease),box-shadow .12s;
}

/* ─── BUTTONS ────────────────────────────────────── */
.ghost-btn{
  background:none;border:1.5px solid var(--b2);color:var(--t2);
  font-size:10.5px;font-weight:700;padding:7px 13px;
  cursor:pointer;font-family:inherit;border-radius:var(--rs);
  transition:border-color var(--dur),color var(--dur),background var(--dur);
}
.ghost-btn:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.solid-btn{
  background:var(--red);color:#fff;border:none;
  font-size:10.5px;font-weight:700;padding:8px 16px;
  cursor:pointer;font-family:inherit;border-radius:var(--rs);
  transition:opacity .15s,transform .1s;
}
.solid-btn:active{opacity:.85;transform:scale(.97)}

/* ─── CROP GRID ──────────────────────────────────── */
.crop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.crop-card{
  border:1.5px solid var(--b1);background:var(--s1);
  padding:13px 14px 10px;cursor:pointer;border-radius:var(--r);
  position:relative;overflow:hidden;
  transition:background var(--dur),border-color var(--dur);
}
.crop-card::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:2.5px;
  background:var(--red);transform:scaleX(0);transform-origin:left;
  transition:transform .22s var(--ease);
}
.crop-card.active{background:var(--s2);border-color:var(--b2)}
.crop-card.active::after{transform:scaleX(1)}
.crop-ratio{font-size:14px;font-weight:900;color:var(--t2);margin-bottom:2px;line-height:1.1}
.crop-card.active .crop-ratio{color:var(--t1)}
.crop-name{font-size:9px;font-weight:700;color:var(--t3);letter-spacing:.5px}

/* ─── ROTATE GRID ────────────────────────────────── */
.rot-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.rot-btn{
  background:var(--s1);border:1.5px solid var(--b1);color:var(--t2);
  font-size:11px;font-weight:700;padding:12px 8px;
  cursor:pointer;font-family:inherit;border-radius:var(--r);
  display:flex;align-items:center;justify-content:center;gap:6px;
  transition:background var(--dur),border-color var(--dur),color var(--dur);
}
.rot-btn:hover{background:var(--s2);border-color:var(--b2);color:var(--t1)}
.rot-btn:active{transform:scale(.97)}
.rot-icon{font-size:16px;line-height:1}

/* ─── RESOLUTION ─────────────────────────────────── */
.res-row{display:flex;align-items:flex-end;gap:10px;margin-bottom:12px}
.res-x{color:var(--t3);font-size:16px;padding-bottom:8px}
.res-inp-w{flex:1}
.inp-lbl{font-size:8.5px;font-weight:700;letter-spacing:1.5px;color:var(--t3);margin-bottom:5px}
input[type=number],input[type=text]{
  background:var(--s1);border:1.5px solid var(--b1);color:var(--t1);
  padding:9px 11px;font-size:12.5px;font-weight:600;font-family:inherit;
  width:100%;outline:none;border-radius:var(--rs);
  transition:border-color .15s;
}
input:focus{border-color:var(--red)}
input::placeholder{color:var(--t3)}
.divider{height:1px;background:var(--b1);margin:12px 0}
.rp-list{display:flex;flex-direction:column;gap:6px}
.rp-cat-hd{
  font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);
  margin-top:10px;margin-bottom:2px;padding-bottom:4px;
  border-bottom:1px solid var(--b1);
}
.rp-cat-hd:first-child{margin-top:0}
.rp-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:11px 13px;border:1.5px solid var(--b1);
  border-radius:var(--r);background:var(--s1);cursor:pointer;
  position:relative;overflow:hidden;
  transition:background var(--dur),border-color var(--dur);
}
.rp-item::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
  background:var(--red);transform:scaleY(0);transform-origin:bottom;
  border-radius:0 2px 2px 0;transition:transform .2s var(--ease);
}
.rp-item.active{background:var(--s2);border-color:var(--b2)}
.rp-item.active::before{transform:scaleY(1)}
.rp-name{font-size:12px;font-weight:700;color:var(--t2)}
.rp-item.active .rp-name{color:var(--t1)}
.rp-dim{font-size:10px;font-weight:600;color:var(--t3)}

/* ─── RGB CURVE ──────────────────────────────────── */
.curve-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:11px;margin-bottom:12px}
.curve-tabs{display:flex;gap:4px;margin-bottom:9px}
.curve-tab{
  flex:1;padding:5px 4px;border:1.5px solid var(--b2);background:none;
  font-family:inherit;font-size:9.5px;font-weight:700;letter-spacing:.5px;
  cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all var(--dur);
}
.curve-tab.active{color:#fff}
.curve-tab[data-ch=L].active{background:var(--s3);border-color:var(--b3)}
.curve-tab[data-ch=R].active{background:#8b0000;border-color:#8b0000}
.curve-tab[data-ch=G].active{background:#005500;border-color:#005500}
.curve-tab[data-ch=B].active{background:#00008b;border-color:#00008b}
#curve-canvas{
  width:100%;height:180px;display:block;border-radius:5px;cursor:crosshair;touch-action:none;
}

/* ─── HSL MIXER ──────────────────────────────────── */
.hsl-color-row{margin-bottom:14px}
.hsl-color-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.hsl-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0}
.hsl-color-name{font-size:11px;font-weight:700;color:var(--t2)}
.hsl-sub-row{
  display:grid;grid-template-columns:26px 1fr 38px;
  align-items:center;gap:6px;margin-bottom:5px;
}
.hsl-sub-lbl{font-size:8.5px;font-weight:700;color:var(--t3);text-align:center}

/* ─── PRESETS ────────────────────────────────────── */
.pi-box{
  background:var(--s1);border:1.5px solid var(--b1);
  padding:13px;margin-bottom:12px;border-radius:var(--r);
  animation:panel-in .2s var(--ease);
}
.pi-btns{display:flex;gap:7px;margin-top:9px}
.preset-card{
  display:flex;align-items:center;gap:9px;
  border:1.5px solid var(--b1);background:var(--s1);
  padding:11px 12px;margin-bottom:7px;border-radius:var(--r);
  transition:border-color var(--dur),background var(--dur);
  animation:panel-in .2s var(--ease);
}
.preset-card:hover{border-color:var(--b2);background:var(--s2)}
.pc-info{flex:1;min-width:0}
.pc-name{font-size:13px;font-weight:700;color:var(--t1);margin-bottom:2px}
.pc-meta{font-size:9px;font-weight:600;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.apply-btn{
  background:var(--red);color:#fff;border:none;
  font-size:9.5px;font-weight:700;padding:7px 11px;
  cursor:pointer;font-family:inherit;border-radius:var(--rs);white-space:nowrap;
}
.del-btn{
  border:1.5px solid var(--b2);background:none;color:var(--t3);
  font-size:12px;padding:6px 10px;cursor:pointer;border-radius:var(--rs);
  transition:border-color var(--dur),color var(--dur);
}
.del-btn:hover{border-color:var(--red);color:var(--red)}

/* ─── INFO ───────────────────────────────────────── */
.info-r{
  display:flex;justify-content:space-between;align-items:center;
  padding:9px 0;border-bottom:1px solid var(--b1);gap:10px;
}
.info-k{font-size:9px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.info-v{font-size:11px;font-weight:600;color:var(--t2);text-align:right;word-break:break-all}
.info-v.hi{color:var(--red)}
.info-sec{margin-top:8px}
.info-sec-hd{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 12px;background:var(--s1);border:1.5px solid var(--b1);
  border-radius:var(--r);cursor:pointer;margin-bottom:3px;
  transition:background var(--dur);
}
.info-sec-hd:hover{background:var(--s2)}
.info-sec-hd.open{border-radius:var(--r) var(--r) 0 0;margin-bottom:0}
.info-sec-title{font-size:10.5px;font-weight:700;color:var(--t2)}
.info-chevron{font-size:10px;color:var(--t3);transition:transform .22s var(--ease)}
.info-sec-hd.open .info-chevron{transform:rotate(180deg)}
.info-sec-body{
  background:var(--s1);border:1.5px solid var(--b2);border-top:none;
  border-radius:0 0 var(--r) var(--r);padding:0 12px;
  overflow:hidden;max-height:0;transition:max-height .3s var(--ease);margin-bottom:4px;
}
.info-sec-body.open{max-height:600px;padding:2px 12px 9px}
.idr{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--b1);gap:8px}
.idr:last-child{border-bottom:none}
.idk{font-size:8.5px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.idv{font-size:10px;font-weight:600;color:var(--t2);text-align:right}
.idv.r{color:var(--red)}

/* ─── EMPTY ──────────────────────────────────────── */
.empty-state{text-align:center;padding:44px 0}
.empty-ring{width:44px;height:44px;border:1.5px solid var(--b2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 13px}
.empty-ring-dot{width:4px;height:4px;background:var(--b2);border-radius:50%}
.empty-ttl{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--t3);margin-bottom:5px}
.empty-sub{font-size:9.5px;font-weight:600;color:#252525;letter-spacing:.5px}

/* ─── BOTTOM BAR ─────────────────────────────────── */
#bottom-bar{
  display:none;gap:8px;padding:10px 14px;
  border-top:1px solid var(--b1);background:var(--bg);flex-shrink:0;
}
.rst-btn{
  flex:1;border:1.5px solid var(--b2);background:none;color:var(--t2);
  padding:12px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;
  border-radius:var(--rs);transition:border-color var(--dur),color var(--dur),background var(--dur);
}
.rst-btn:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.exp-btn{
  flex:2;background:var(--red);color:#fff;border:none;
  padding:12px;font-size:12px;font-weight:700;letter-spacing:.8px;
  cursor:pointer;font-family:inherit;border-radius:var(--rs);
  transition:opacity .15s,transform .1s;
}
.exp-btn:active{opacity:.85;transform:scale(.98)}

/* ─── EXPORT MODAL ───────────────────────────────── */
#exp-modal{
  position:fixed;inset:0;z-index:800;
  background:rgba(0,0,0,.75);
  display:none;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
}
#exp-modal.open{display:flex;animation:modal-in .25s ease}
@keyframes modal-in{from{opacity:0}to{opacity:1}}
.modal-sheet{
  background:var(--s1);border:1.5px solid var(--b2);
  border-radius:var(--r) var(--r) 0 0;
  padding:18px 18px 36px;width:100%;max-width:480px;
  animation:sheet-up .28s var(--ease);
}
@keyframes sheet-up{from{transform:translateY(36px)}to{transform:none}}
.modal-title{font-size:12px;font-weight:800;letter-spacing:2.5px;color:var(--t2);margin-bottom:13px}
.fmt-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:13px}
.fmt-opt{
  border:1.5px solid var(--b2);background:var(--s2);padding:12px;
  border-radius:var(--rs);cursor:pointer;text-align:center;
  transition:all var(--dur);
}
.fmt-opt.active{border-color:var(--red);background:var(--red-a)}
.fmt-name{font-size:11px;font-weight:700;color:var(--t2)}
.fmt-opt.active .fmt-name{color:var(--t1)}
.fmt-desc{font-size:9px;color:var(--t3);margin-top:2px}
.modal-btns{display:flex;gap:8px}

/* ─── SCROLLBAR ──────────────────────────────────── */
::-webkit-scrollbar{width:2px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--b3);border-radius:2px}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-ring"><div class="sp-dot"></div></div>
  <div class="sp-title">LENS</div>
  <div class="sp-sub" id="sp-sub">PHOTO EDITOR</div>
  <div class="sp-cta">
    <div class="sp-line"></div><span id="sp-cta">TAP TO BEGIN</span><div class="sp-line"></div>
  </div>
</div>
</div>

<!-- APP -->
<div id="app">

  <!-- LEFT PANE -->
  <div id="left-pane">
    <header>
      <div class="logo">
        <div class="hdr-dot"></div>
        <div>
          <div class="logo-n">LENS</div>
          <div class="logo-s" data-i="appSub">PHOTO EDITOR</div>
        </div>
      </div>
      <div class="hdr-r">
        <button class="hbtn" onclick="toggleLang()" id="lang-btn">日本語</button>
        <button class="hbtn" onclick="triggerOpen()" data-i="open">OPEN</button>
        <button class="hbtn red" id="hd-export" style="display:none" onclick="openModal()" data-i="export">EXPORT</button>
        <input id="fi" type="file" accept="image/*" style="display:none" onchange="onFileLoad(event)"/>
      </div>
    </header>

    <!-- PREVIEW -->
    <div id="preview-area" onclick="triggerOpen()">
      <div id="checker-bg"></div>
      <div class="ph-wrap" id="ph">
        <div class="ph-ring"><div class="ph-dot"></div></div>
        <div class="ph-txt" data-i="tapOpen">TAP TO OPEN</div>
      </div>
      <canvas id="preview-canvas"></canvas>
      <div class="exp-bar"><div class="exp-fill" id="exp-fill"></div></div>
    </div>
  </div><!-- /left-pane -->

  <!-- RIGHT PANE -->
  <div id="right-pane">
    <div id="editor-area">

      <!-- TABS -->
      <div class="tabs">
        <button class="tab active" data-tab="tone" onclick="sw('tone')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5"/><line x1="8" y1="3" x2="8" y2="13"/></svg>
          <span class="tab-lbl" data-i="tabTone">TONE</span>
        </button>
        <button class="tab" data-tab="color" onclick="sw('color')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2a6 6 0 100 12A6 6 0 008 2z"/><path d="M8 2c2 2 2 8 0 12M8 2C6 4 6 10 8 14"/></svg>
          <span class="tab-lbl" data-i="tabColor">COLOR</span>
        </button>
        <button class="tab" data-tab="detail" onclick="sw('detail')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8h10M8 3v10M4.5 4.5l7 7M11.5 4.5l-7 7"/></svg>
          <span class="tab-lbl" data-i="tabDetail">DETAIL</span>
        </button>
        <button class="tab" data-tab="transform" onclick="sw('transform')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 3L2 8l3 5M11 3l3 5-3 5"/><line x1="2" y1="8" x2="14" y2="8"/></svg>
          <span class="tab-lbl" data-i="tabTransform">ROTATE</span>
        </button>
        <button class="tab" data-tab="cut" onclick="sw('cut')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="10" height="10" rx="1"/><line x1="3" y1="7" x2="13" y2="7"/><line x1="7" y1="3" x2="7" y2="13"/></svg>
          <span class="tab-lbl" data-i="tabCut">CUT</span>
        </button>
        <button class="tab" data-tab="size" onclick="sw('size')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="8" height="8" rx="1"/><rect x="6" y="2" width="8" height="8" rx="1"/></svg>
          <span class="tab-lbl" data-i="tabSize">SIZE</span>
        </button>
        <button class="tab" data-tab="preset" onclick="sw('preset')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8a4 4 0 108 0 4 4 0 00-8 0z"/><path d="M8 5v3l2 2"/></svg>
          <span class="tab-lbl" data-i="tabPreset">PRESET</span>
        </button>
        <button class="tab" data-tab="info" onclick="sw('info')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><line x1="8" y1="7" x2="8" y2="11"/><circle cx="8" cy="5" r=".5" fill="currentColor"/></svg>
          <span class="tab-lbl" data-i="tabInfo">INFO</span>
        </button>
      </div>

      <!-- PANELS -->
      <div class="panel-wrap">

        <!-- TONE -->
        <div class="panel active" id="panel-tone">
          <div class="pnl-hd">
            <div class="pnl-title" data-i="panelTone">TONE & LIGHT</div>
            <button class="ghost-btn" onclick="resetAdj()" data-i="reset">RESET</button>
          </div>
          <div id="sliders-tone"></div>
        </div>

        <!-- COLOR -->
        <div class="panel" id="panel-color">
          <div class="pnl-title" data-i="panelColor">COLOR GRADING</div>

          <!-- Basic color sliders -->
          <div id="sliders-color"></div>

          <!-- RGB Curve -->
          <div class="sl-section">
            <div class="sl-section-hd">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="rgbCurve">RGB CURVE</span></div>
            </div>
            <div class="sl-section-body">
              <div class="curve-wrap">
                <div class="curve-tabs">
                  <button class="curve-tab active" data-ch="L" onclick="setCurveCh(this,'L')">LUMA</button>
                  <button class="curve-tab" data-ch="R" onclick="setCurveCh(this,'R')">R</button>
                  <button class="curve-tab" data-ch="G" onclick="setCurveCh(this,'G')">G</button>
                  <button class="curve-tab" data-ch="B" onclick="setCurveCh(this,'B')">B</button>
                </div>
                <canvas id="curve-canvas"></canvas>
                <div style="font-size:8.5px;color:var(--t3);margin-top:6px;letter-spacing:.5px" data-i="curveHint">DRAG POINTS • CLICK TO ADD • DBL-TAP TO REMOVE</div>
              </div>
            </div>
          </div>

          <!-- HSL Mixer -->
          <div class="sl-section">
            <div class="sl-section-hd clickable" onclick="toggleSection(this)">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="hslMixer">HSL MIXER</span></div>
              <span class="sl-sec-arrow">▾</span>
            </div>
            <div class="sl-section-body">
              <div id="hsl-panel"></div>
            </div>
          </div>

          <!-- Advanced color (collapsed by default) -->
          <div class="sl-section collapsed">
            <div class="sl-section-hd clickable" onclick="toggleSection(this)">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="advColor">ADVANCED COLOR</span></div>
              <span class="sl-sec-arrow">▾</span>
            </div>
            <div class="sl-section-body">
              <div id="sliders-advanced"></div>
            </div>
          </div>
        </div>

        <!-- DETAIL -->
        <div class="panel" id="panel-detail">
          <div class="pnl-title" data-i="panelDetail">DETAIL & OPTICS</div>
          <div id="sliders-detail"></div>
        </div>

        <!-- TRANSFORM -->
        <div class="panel" id="panel-transform">
          <div class="pnl-title" data-i="panelTransform">ROTATE & TRANSFORM</div>
          <div class="rot-grid">
            <button class="rot-btn" onclick="doRotate(-90)"><span class="rot-icon">↺</span><span data-i="rotL">Rotate Left</span></button>
            <button class="rot-btn" onclick="doRotate(90)"><span class="rot-icon">↻</span><span data-i="rotR">Rotate Right</span></button>
            <button class="rot-btn" onclick="doFlipH()"><span class="rot-icon">⇄</span><span data-i="flipH">Flip H</span></button>
            <button class="rot-btn" onclick="doFlipV()"><span class="rot-icon">⇅</span><span data-i="flipV">Flip V</span></button>
          </div>
          <div id="sliders-transform"></div>
        </div>

        <!-- CUT -->
        <div class="panel" id="panel-cut">
          <div class="pnl-title" data-i="panelCut">CUT & FRAME</div>
          <div class="crop-grid">
            <div class="crop-card active" onclick="pickCrop(this)"><div class="crop-ratio">1:1</div><div class="crop-name" data-i="square">SQUARE</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">4:3</div><div class="crop-name" data-i="standard">STANDARD</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">16:9</div><div class="crop-name" data-i="wide">WIDE</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">3:4</div><div class="crop-name" data-i="portrait">PORTRAIT</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">9:16</div><div class="crop-name" data-i="story">STORY</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">FREE</div><div class="crop-name" data-i="custom">CUSTOM</div></div>
          </div>
        </div>

        <!-- SIZE -->
        <div class="panel" id="panel-size">
          <div class="pnl-title" data-i="panelSize">OUTPUT SIZE</div>
          <div class="res-row">
            <div class="res-inp-w"><div class="inp-lbl" data-i="widthPx">WIDTH px</div><input type="number" id="rw" value="1080" oninput="onResChange()"/></div>
            <div class="res-x">×</div>
            <div class="res-inp-w"><div class="inp-lbl" data-i="heightPx">HEIGHT px</div><input type="number" id="rh" value="1080" oninput="onResChange()"/></div>
          </div>
          <div class="divider"></div>
          <div class="rp-list" id="rp-list"></div>
        </div>

        <!-- PRESET -->
        <div class="panel" id="panel-preset">
          <div class="pnl-hd">
            <div class="pnl-title" data-i="panelPreset">SAVED PRESETS</div>
            <button class="solid-btn" onclick="showPI()" data-i="saveNew">＋ SAVE</button>
          </div>
          <div id="pi-box" style="display:none" class="pi-box">
            <div class="inp-lbl" data-i="presetName">PRESET NAME</div>
            <input type="text" id="pi-name" style="margin-bottom:9px"/>
            <div class="pi-btns">
              <button class="solid-btn" style="flex:1" onclick="savePreset()" data-i="save">SAVE</button>
              <button class="ghost-btn" style="flex:1" onclick="hidePI()" data-i="cancel">CANCEL</button>
            </div>
          </div>
          <div id="preset-list"></div>
        </div>

        <!-- INFO -->
        <div class="panel" id="panel-info">
          <div class="pnl-title" data-i="panelInfo">IMAGE DATA</div>
          <div id="info-body">
            <div class="empty-state">
              <div class="empty-ring"><div class="empty-ring-dot"></div></div>
              <div class="empty-ttl" data-i="noImg">NO IMAGE LOADED</div>
              <div class="empty-sub" data-i="openToView">OPEN AN IMAGE TO VIEW DATA</div>
            </div>
          </div>
        </div>

      </div><!-- /panel-wrap -->
    </div><!-- /editor-area -->

    <!-- BOTTOM BAR -->
    <div id="bottom-bar">
      <button class="rst-btn" onclick="resetAdj()" data-i="reset">RESET</button>
      <button class="exp-btn" onclick="openModal()" data-i="export">EXPORT IMAGE</button>
    </div>
  </div><!-- /right-pane -->
</div><!-- /app -->

<!-- EXPORT MODAL -->
<div id="exp-modal">
  <div class="modal-sheet">
    <div class="modal-title" data-i="exportTitle">EXPORT OPTIONS</div>
    <div class="fmt-grid">
      <div class="fmt-opt active" onclick="pickFmt(this,'jpg')"><div class="fmt-name">JPEG</div><div class="fmt-desc">Best quality photo</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'png')"><div class="fmt-name">PNG</div><div class="fmt-desc">Lossless</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'webp')"><div class="fmt-name">WEBP</div><div class="fmt-desc">Small file</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'transparent')"><div class="fmt-name">PNG BG</div><div class="fmt-desc" data-i="bgOff">Background off</div></div>
    </div>
    <div class="modal-btns">
      <button class="ghost-btn" style="flex:1" onclick="closeModal()" data-i="cancel">CANCEL</button>
      <button class="solid-btn" style="flex:2" onclick="doExport()" data-i="doExport">DOWNLOAD</button>
    </div>
  </div>
</div>

<canvas id="offscreen" style="display:none"></canvas>

<script>
(function(){
/* ══════════════════════════════════
   i18n
══════════════════════════════════ */
const I18N={
en:{
  appSub:'PHOTO EDITOR',open:'OPEN',tapOpen:'TAP TO OPEN',splashCta:'TAP TO BEGIN',
  export:'EXPORT',exportTitle:'EXPORT OPTIONS',doExport:'DOWNLOAD',bgOff:'Background off',cancel:'CANCEL',
  tabTone:'TONE',tabColor:'COLOR',tabDetail:'DETAIL',tabTransform:'ROTATE',tabCut:'CUT',tabSize:'SIZE',tabPreset:'PRESET',tabInfo:'INFO',
  panelTone:'TONE & LIGHT',panelColor:'COLOR GRADING',panelDetail:'DETAIL & OPTICS',
  panelTransform:'ROTATE & TRANSFORM',panelCut:'CUT & FRAME',panelSize:'OUTPUT SIZE',panelPreset:'SAVED PRESETS',panelInfo:'IMAGE DATA',
  reset:'RESET',saveNew:'＋ SAVE',save:'SAVE',presetName:'PRESET NAME',
  rgbCurve:'RGB CURVE',curveHint:'DRAG POINTS · CLICK TO ADD · DBL-TAP TO REMOVE',
  hslMixer:'HSL MIXER',advColor:'ADVANCED COLOR',
  rotL:'Rotate Left',rotR:'Rotate Right',flipH:'Flip H',flipV:'Flip V',
  widthPx:'WIDTH px',heightPx:'HEIGHT px',
  square:'SQUARE',standard:'STANDARD',wide:'WIDE',portrait:'PORTRAIT',story:'STORY',custom:'CUSTOM',
  noImg:'NO IMAGE LOADED',openToView:'OPEN AN IMAGE TO VIEW DATA',
  langToggle:'日本語',applyBtn:'APPLY',deleteBtn:'✕',noPresets:'NO PRESETS',noPresetsSub:'ADJUST AND SAVE YOUR LOOK',
  // sliders
  sBrightness:'Brightness',sContrast:'Contrast',sExposure:'Exposure',sHighlights:'Highlights',sShadows:'Shadows',sBlacks:'Blacks',sWhites:'Whites',
  sSaturation:'Saturation',sVibrance:'Vibrance',sHue:'Hue Shift',sTemperature:'Temperature',sTint:'Tint',
  sSharpness:'Sharpness',sBlur:'Blur',sClarity:'Clarity',sVignette:'Vignette',sLens:'Lens Correction',sChrAb:'Chromatic Aberration',sNoise:'Noise (Luma)',sNoiseC:'Noise (Chroma)',sGrain:'Film Grain',sFade:'Fade',sDistortion:'Distortion',
  sAngle:'Fine Angle',sPerspH:'Perspective H',sPerspV:'Perspective V',
  sRR:'Red → Red',sRG:'Red → Green',sRB:'Red → Blue',sGR:'Green → Red',sGG:'Green → Green',sGB:'Green → Blue',sBR:'Blue → Red',sBG:'Blue → Green',sBB:'Blue → Blue',
  // res
  rpHD:'HD',rpFHD:'Full HD',rpQHD:'2K QHD',rp4K:'4K UHD',rp8K:'8K',
  rpIG:'Instagram Square',rpIGPort:'Instagram Portrait',rpIGLand:'Instagram Landscape',
  rpSt:'Story / Reel',rpX:'X (Twitter) Post',rpTW:'X (Twitter) Banner',
  rpFB:'Facebook OG',rpYT:'YouTube Thumb',rpTT:'TikTok',
  rpA4L:'A4 Landscape',rpA4P:'A4 Portrait',rpA3L:'A3 Landscape',rpA3P:'A3 Portrait',
  rpSq1k:'Square 1K',rpSq2k:'Square 2K',rpSq4k:'Square 4K',
  // info
  infoFile:'Filename',infoSize:'File Size',infoType:'Format',infoW:'Native W',infoH:'Native H',infoMP:'Megapixels',infoAR:'Aspect Ratio',infoOutW:'Output W',infoOutH:'Output H',detailTitle:'Technical Details',adjTitle:'Adjustments',infoCS:'Color Space',infoDP:'Bit Depth',infoTP:'Total Pixels',noneAdj:'NONE',
},
ja:{
  appSub:'フォトエディター',open:'開く',tapOpen:'タップして開く',splashCta:'タップして開始',
  export:'書き出す',exportTitle:'書き出し設定',doExport:'ダウンロード',bgOff:'背景透過',cancel:'キャンセル',
  tabTone:'トーン',tabColor:'カラー',tabDetail:'詳細',tabTransform:'回転',tabCut:'カット',tabSize:'サイズ',tabPreset:'プリセット',tabInfo:'情報',
  panelTone:'トーン・露光',panelColor:'カラーグレーディング',panelDetail:'ディテール・光学',
  panelTransform:'回転・変形',panelCut:'カット・フレーム',panelSize:'出力サイズ',panelPreset:'保存済みプリセット',panelInfo:'画像情報',
  reset:'リセット',saveNew:'＋ 保存',save:'保存',presetName:'プリセット名',
  rgbCurve:'RGBカーブ',curveHint:'ドラッグで移動 · タップで追加 · ダブルタップで削除',
  hslMixer:'HSLミキサー',advColor:'高度なカラー',
  rotL:'左回転',rotR:'右回転',flipH:'水平反転',flipV:'垂直反転',
  widthPx:'横幅 px',heightPx:'縦幅 px',
  square:'スクエア',standard:'スタンダード',wide:'ワイド',portrait:'ポートレート',story:'ストーリー',custom:'カスタム',
  noImg:'画像が読み込まれていません',openToView:'画像を開くと情報が表示されます',
  langToggle:'English',applyBtn:'適用',deleteBtn:'✕',noPresets:'プリセットなし',noPresetsSub:'調整して保存しましょう',
  sBrightness:'明るさ',sContrast:'コントラスト',sExposure:'露出',sHighlights:'ハイライト',sShadows:'シャドウ',sBlacks:'黒レベル',sWhites:'白レベル',
  sSaturation:'彩度',sVibrance:'自然な彩度',sHue:'色相シフト',sTemperature:'色温度',sTint:'ティント',
  sSharpness:'シャープ',sBlur:'ぼかし',sClarity:'明瞭度',sVignette:'周辺減光',sLens:'周辺光量補正',sChrAb:'色収差',sNoise:'ノイズ(輝度)',sNoiseC:'ノイズ(色)',sGrain:'フィルムグレイン',sFade:'フェード',sDistortion:'歪み補正',
  sAngle:'微調整角度',sPerspH:'水平補正',sPerspV:'垂直補正',
  sRR:'赤→赤',sRG:'赤→緑',sRB:'赤→青',sGR:'緑→赤',sGG:'緑→緑',sGB:'緑→青',sBR:'青→赤',sBG:'青→緑',sBB:'青→青',
  rpHD:'HD',rpFHD:'フルHD',rpQHD:'2K QHD',rp4K:'4K UHD',rp8K:'8K',
  rpIG:'Instagramスクエア',rpIGPort:'Instagramポートレート',rpIGLand:'Instagramランドスケープ',
  rpSt:'ストーリー / リール',rpX:'X(Twitter)投稿',rpTW:'X(Twitter)バナー',
  rpFB:'Facebook OG',rpYT:'YouTubeサムネ',rpTT:'TikTok',
  rpA4L:'A4 横',rpA4P:'A4 縦',rpA3L:'A3 横',rpA3P:'A3 縦',
  rpSq1k:'スクエア 1K',rpSq2k:'スクエア 2K',rpSq4k:'スクエア 4K',
  infoFile:'ファイル名',infoSize:'ファイルサイズ',infoType:'形式',infoW:'元の幅',infoH:'元の高さ',infoMP:'メガピクセル',infoAR:'アスペクト比',infoOutW:'出力幅',infoOutH:'出力高さ',detailTitle:'テクニカル詳細',adjTitle:'適用中の調整',infoCS:'カラースペース',infoDP:'ビット深度',infoTP:'総ピクセル数',noneAdj:'なし',
}};
let L='en';
function tr(k){return I18N[L][k]||I18N.en[k]||k}
function applyLang(){
  document.getElementById('lang-btn').textContent=tr('langToggle');
  document.querySelectorAll('[data-i]').forEach(el=>el.textContent=tr(el.dataset.i));
  buildAllSliders();buildRes();buildPresets();buildInfo();
  updSplash();
}
function toggleLang(){L=L==='en'?'ja':'en';applyLang()}

/* ══════════════════════════════════
   State
══════════════════════════════════ */
const DEF={
  brightness:0,contrast:0,exposure:0,highlights:0,shadows:0,blacks:0,whites:0,
  saturation:0,vibrance:0,hue:0,temperature:0,tint:0,
  sharpness:0,blur:0,clarity:0,vignette:0,lens:0,chrAb:0,noise:0,noiseC:0,grain:0,fade:0,distortion:0,
  angle:0,perspH:0,perspV:0,
  rr:0,rg:0,rb:0,gr:0,gg:0,gb:0,br:0,bg2:0,bb:0,
};
const HSL_COLS=['Red','Orange','Yellow','Green','Aqua','Blue','Purple','Magenta'];
const HSL_DOTS=['#e02020','#f87020','#ddb800','#10a020','#00b8cc','#1060e0','#8820e0','#d010a0'];
HSL_COLS.forEach(c=>{DEF['hH_'+c]=0;DEF['hS_'+c]=0;DEF['hL_'+c]=0});

let adj={...DEF};
let rotDeg=0,fH=false,fV=false;
let rw=1080,rh=1080;
let srcImg=null,imgMeta=null;
let exportFmt='jpg';
let presets=JSON.parse(localStorage.getItem('lens_v7')||'[]');

/* ── Curve state ── */
const curves={
  L:[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]],
  R:[[0,0],[.5,.5],[1,1]],
  G:[[0,0],[.5,.5],[1,1]],
  B:[[0,0],[.5,.5],[1,1]],
};
let curveCh='L';

/* ══════════════════════════════════
   Slider definitions
══════════════════════════════════ */
function slDef(key,lbl,min,max){return{key,lbl,min,max}}
const GROUPS={
  tone:[
    slDef('brightness','sBrightness',-100,100),
    slDef('contrast','sContrast',-100,100),
    slDef('exposure','sExposure',-100,100),
    slDef('highlights','sHighlights',-100,100),
    slDef('shadows','sShadows',-100,100),
    slDef('blacks','sBlacks',-100,100),
    slDef('whites','sWhites',-100,100),
  ],
  color:[
    slDef('saturation','sSaturation',-100,100),
    slDef('vibrance','sVibrance',-100,100),
    slDef('hue','sHue',-180,180),
    slDef('temperature','sTemperature',-100,100),
    slDef('tint','sTint',-100,100),
  ],
  detail:[
    slDef('sharpness','sSharpness',0,100),
    slDef('blur','sBlur',0,30),
    slDef('clarity','sClarity',-100,100),
    slDef('vignette','sVignette',0,100),
    slDef('lens','sLens',-100,100),
    slDef('chrAb','sChrAb',0,30),
    slDef('noise','sNoise',0,100),
    slDef('noiseC','sNoiseC',0,100),
    slDef('grain','sGrain',0,100),
    slDef('fade','sFade',0,100),
    slDef('distortion','sDistortion',-50,50),
  ],
  transform:[
    slDef('angle','sAngle',-45,45),
    slDef('perspH','sPerspH',-50,50),
    slDef('perspV','sPerspV',-50,50),
  ],
  advanced:[
    slDef('rr','sRR',-100,100),slDef('rg','sRG',-100,100),slDef('rb','sRB',-100,100),
    slDef('gr','sGR',-100,100),slDef('gg','sGG',-100,100),slDef('gb','sGB',-100,100),
    slDef('br','sBR',-100,100),slDef('bg2','sBG',-100,100),slDef('bb','sBB',-100,100),
  ],
};

/* ══════════════════════════════════
   Slider Builder
══════════════════════════════════ */
function pct(v,min,max){return((v-min)/(max-min))*100}
function fillCSS(v,min,max){
  const p=pct(v,min,max);
  if(min<0){
    if(v>=0)return{left:'50%',width:(p-50)+'%'};
    return{left:p+'%',width:(50-p)+'%'};
  }
  return{left:'0%',width:p+'%'};
}
function fmtNum(v){return v>0?'+'+v:String(v)}

function buildSliderHTML(key,lbl,min,max){
  const v=adj[key]??0;
  const p=pct(v,min,max);
  const f=fillCSS(v,min,max);
  const hasMid=min<0;
  return`<div class="sl-row" id="row-${key}">
  <div class="sl-top">
    <span class="sl-label">${tr(lbl)}</span>
    <div class="sl-badge">
      <span class="sl-num${v!==0?' nonzero':''}" id="num-${key}" onclick="openNumInput('${key}',${min},${max})">${fmtNum(v)}</span>
      <input class="sl-input" id="inp-${key}" type="number" min="${min}" max="${max}"
        onblur="closeNumInput('${key}',${min},${max})"
        onkeydown="numKey(event,'${key}',${min},${max})"/>
    </div>
  </div>
  <div class="sl-track-hit" id="hit-${key}" data-key="${key}" data-min="${min}" data-max="${max}">
    <div class="sl-track-bg">
      ${hasMid?'<div class="sl-center"></div>':''}
      <div class="sl-fill" id="fill-${key}" style="left:${f.left};width:${f.width}"></div>
      <div class="sl-thumb" id="thumb-${key}" style="left:${p}%"></div>
    </div>
  </div>
</div>`;
}

function buildGroup(defs,containerId){
  const el=document.getElementById(containerId);
  if(!el)return;
  el.innerHTML=defs.map(d=>buildSliderHTML(d.key,d.lbl,d.min,d.max)).join('');
  defs.forEach(d=>attachSlider(document.getElementById('hit-'+d.key),d.key,d.min,d.max));
}

function buildAllSliders(){
  buildGroup(GROUPS.tone,'sliders-tone');
  buildGroup(GROUPS.color,'sliders-color');
  buildGroup(GROUPS.detail,'sliders-detail');
  buildGroup(GROUPS.transform,'sliders-transform');
  buildGroup(GROUPS.advanced,'sliders-advanced');
  buildHSL();
}

/* ══════════════════════════════════
   Zero-lag drag — pointer events
══════════════════════════════════ */
function attachSlider(hit,key,min,max){
  if(!hit)return;
  let active=false;

  function fromX(clientX){
    const bg=hit.querySelector('.sl-track-bg');
    const r=bg.getBoundingClientRect();
    const p=Math.max(0,Math.min(1,(clientX-r.left)/r.width));
    const raw=min+p*(max-min);
    return Math.round(raw);
  }

  function set(clientX){
    const v=fromX(clientX);
    if(adj[key]===v)return;
    adj[key]=v;
    // Direct DOM mutation — no RAF needed, runs in same frame as pointer event
    setSliderUI(key,v,min,max);
    scheduleRender();
  }

  hit.addEventListener('pointerdown',e=>{
    active=true;
    hit.classList.add('active');
    hit.setPointerCapture(e.pointerId);
    set(e.clientX);
    e.preventDefault();
  },{passive:false});

  hit.addEventListener('pointermove',e=>{
    if(!active)return;
    set(e.clientX);
  },{passive:true});

  const end=()=>{active=false;hit.classList.remove('active')};
  hit.addEventListener('pointerup',end);
  hit.addEventListener('pointercancel',end);
}

function setSliderUI(key,v,min,max){
  const p=pct(v,min,max);
  const f=fillCSS(v,min,max);
  const num=document.getElementById('num-'+key);
  const fill=document.getElementById('fill-'+key);
  const thumb=document.getElementById('thumb-'+key);
  if(num){num.textContent=fmtNum(v);num.className='sl-num'+(v!==0?' nonzero':'')}
  if(fill){fill.style.left=f.left;fill.style.width=f.width}
  if(thumb){thumb.style.left=p+'%'}
}

/* ══════════════════════════════════
   Number input on tap
══════════════════════════════════ */
function openNumInput(key,min,max){
  const num=document.getElementById('num-'+key);
  const inp=document.getElementById('inp-'+key);
  if(!num||!inp)return;
  inp.value=adj[key];
  num.style.display='none';
  inp.style.display='block';
  // slight delay so keyboard opens smoothly
  setTimeout(()=>{inp.focus();inp.select()},10);
}
function closeNumInput(key,min,max){
  const num=document.getElementById('num-'+key);
  const inp=document.getElementById('inp-'+key);
  if(!num||!inp)return;
  let v=parseInt(inp.value,10);
  if(isNaN(v))v=adj[key];
  v=Math.max(min,Math.min(max,v));
  adj[key]=v;
  setSliderUI(key,v,min,max);
  scheduleRender();
  inp.style.display='none';
  num.style.display='';
}
function numKey(e,key,min,max){
  if(e.key==='Enter'||e.key==='Escape')closeNumInput(key,min,max);
}

/* ══════════════════════════════════
   HSL sliders
══════════════════════════════════ */
function buildHSL(){
  const container=document.getElementById('hsl-panel');
  if(!container)return;
  const subs=[{s:'H',min:-50,max:50},{s:'S',min:-100,max:100},{s:'L',min:-100,max:100}];
  container.innerHTML=HSL_COLS.map((c,i)=>`
    <div class="hsl-color-row">
      <div class="hsl-color-head">
        <div class="hsl-dot" style="background:${HSL_DOTS[i]}"></div>
        <span class="hsl-color-name">${c}</span>
      </div>
      ${subs.map(({s,min,max})=>{
        const key='h'+s+'_'+c;const v=adj[key]??0;
        const p=pct(v,min,max);const f=fillCSS(v,min,max);
        return`<div class="hsl-sub-row">
          <span class="hsl-sub-lbl">${s}</span>
          <div class="sl-track-hit" id="hit-${key}" data-key="${key}" data-min="${min}" data-max="${max}">
            <div class="sl-track-bg">
              <div class="sl-center"></div>
              <div class="sl-fill" id="fill-${key}" style="left:${f.left};width:${f.width}"></div>
              <div class="sl-thumb" id="thumb-${key}" style="left:${p}%"></div>
            </div>
          </div>
          <span class="sl-num${v!==0?' nonzero':''}" id="num-${key}">${fmtNum(v)}</span>
        </div>`;
      }).join('')}
    </div>`).join('');
  HSL_COLS.forEach(c=>subs.forEach(({s,min,max})=>{
    const key='h'+s+'_'+c;
    const hit=document.getElementById('hit-'+key);
    if(hit)attachSlider(hit,key,min,max);
  }));
}

/* ══════════════════════════════════
   Toggle collapse sections
══════════════════════════════════ */
function toggleSection(hd){
  const section=hd.parentElement;
  section.classList.toggle('collapsed');
}

/* ══════════════════════════════════
   Render pipeline — rAF-based
══════════════════════════════════ */
let renderQueued=false;
function scheduleRender(){
  if(renderQueued)return;
  renderQueued=true;
  requestAnimationFrame(()=>{renderQueued=false;renderCanvas()});
}

function renderCanvas(){
  if(!srcImg)return;
  const area=document.getElementById('preview-area');
  const cv=document.getElementById('preview-canvas');
  const AW=area.clientWidth,AH=area.clientHeight;
  if(!AW||!AH)return;

  const iw=srcImg.naturalWidth,ih=srcImg.naturalHeight;
  const sc=Math.min(AW/iw,AH/ih);
  const cw=Math.round(iw*sc),ch=Math.round(ih*sc);

  if(cv.width!==cw||cv.height!==ch){cv.width=cw;cv.height=ch}
  cv.style.width=cw+'px';cv.style.height=ch+'px';

  const ctx=cv.getContext('2d',{willReadFrequently:false});
  ctx.clearRect(0,0,cw,ch);

  // transforms
  ctx.save();
  ctx.translate(cw/2,ch/2);
  const a=(rotDeg+adj.angle)*Math.PI/180;
  if(a!==0)ctx.rotate(a);
  if(fH)ctx.scale(-1,1);
  if(fV)ctx.scale(1,-1);

  // CSS filter
  const b=1+adj.brightness/100;
  const c=Math.max(0.01,1+adj.contrast/100);
  const s=Math.max(0,1+adj.saturation/100);
  const blr=adj.blur>0?`blur(${(adj.blur*0.25).toFixed(2)}px)`:'';
  const hr=adj.hue?`hue-rotate(${adj.hue}deg)`:'';
  ctx.filter=[`brightness(${b.toFixed(3)})`,`contrast(${c.toFixed(3)})`,`saturate(${s.toFixed(3)})`,blr,hr].filter(Boolean).join(' ');
  ctx.drawImage(srcImg,-cw/2,-ch/2,cw,ch);
  ctx.restore();
  ctx.filter='none';

  // Vignette (radial gradient overlay)
  if(adj.vignette>0){
    const vg=ctx.createRadialGradient(cw/2,ch/2,0,cw/2,ch/2,Math.hypot(cw,ch)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.6),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${(adj.vignette/100*0.85).toFixed(3)})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,cw,ch);
  }
  // Fade
  if(adj.fade>0){
    ctx.fillStyle=`rgba(255,255,255,${(adj.fade/100*0.38).toFixed(3)})`;
    ctx.fillRect(0,0,cw,ch);
  }

  // Exposure bar
  document.getElementById('exp-fill').style.width=(50+adj.exposure/2)+'%';
}

/* ══════════════════════════════════
   Image loading
══════════════════════════════════ */
function triggerOpen(){
  if(srcImg)return;
  document.getElementById('fi').click();
}
function onFileLoad(e){
  const f=e.target.files[0];if(!f)return;
  const img=new Image();
  img.onload=()=>{
    srcImg=img;
    const ph=document.getElementById('ph');
    ph.style.transition='opacity .3s';ph.style.opacity='0';
    setTimeout(()=>ph.style.display='none',300);
    const cv=document.getElementById('preview-canvas');
    cv.style.display='block';
    const area=document.getElementById('preview-area');
    area.onclick=null;area.classList.add('has-img');
    document.getElementById('bottom-bar').style.display='flex';
    document.getElementById('hd-export').style.display='';
    document.getElementById('checker-bg').style.display='block';
    imgMeta={name:f.name,size:(f.size/1024).toFixed(1)+' KB',type:f.type,
      w:img.naturalWidth,h:img.naturalHeight,
      mp:((img.naturalWidth*img.naturalHeight)/1e6).toFixed(2),
      ar:(img.naturalWidth/img.naturalHeight).toFixed(3),
      totalPx:(img.naturalWidth*img.naturalHeight).toLocaleString()};
    scheduleRender();buildInfo();
  };
  img.src=URL.createObjectURL(f);
}

/* ══════════════════════════════════
   Tabs
══════════════════════════════════ */
function sw(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active',p.id==='panel-'+id));
  if(id==='color')drawCurve();
}

/* ══════════════════════════════════
   Crop
══════════════════════════════════ */
function pickCrop(el){
  document.querySelectorAll('.crop-card').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
}

/* ══════════════════════════════════
   Rotate / Flip
══════════════════════════════════ */
function doRotate(d){rotDeg=(rotDeg+d+360)%360;scheduleRender()}
function doFlipH(){fH=!fH;scheduleRender()}
function doFlipV(){fV=!fV;scheduleRender()}

/* ══════════════════════════════════
   Reset
══════════════════════════════════ */
function resetAdj(){
  adj={...DEF};rotDeg=0;fH=false;fV=false;
  curves.L=[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]];
  curves.R=[[0,0],[.5,.5],[1,1]];curves.G=[[0,0],[.5,.5],[1,1]];curves.B=[[0,0],[.5,.5],[1,1]];
  buildAllSliders();scheduleRender();drawCurve();
}

/* ══════════════════════════════════
   Resolution
══════════════════════════════════ */
const RP=[
  // SNS
  {k:'rpIG',        w:1080,h:1080, cat:'SNS'},
  {k:'rpIGPort',    w:1080,h:1350, cat:'SNS'},
  {k:'rpIGLand',    w:1080,h:566,  cat:'SNS'},
  {k:'rpSt',        w:1080,h:1920, cat:'SNS'},
  {k:'rpX',         w:1200,h:675,  cat:'SNS'},
  {k:'rpTW',        w:1500,h:500,  cat:'SNS'},
  {k:'rpFB',        w:1200,h:630,  cat:'SNS'},
  {k:'rpYT',        w:1280,h:720,  cat:'SNS'},
  {k:'rpTT',        w:1080,h:1920, cat:'SNS'},
  // Standard
  {k:'rpHD',        w:1280,h:720,  cat:'HD'},
  {k:'rpFHD',       w:1920,h:1080, cat:'HD'},
  {k:'rpQHD',       w:2560,h:1440, cat:'HD'},
  {k:'rp4K',        w:3840,h:2160, cat:'HD'},
  {k:'rp8K',        w:7680,h:4320, cat:'HD'},
  // Print A-series
  {k:'rpA4L',       w:3508,h:2480, cat:'Print'},
  {k:'rpA4P',       w:2480,h:3508, cat:'Print'},
  {k:'rpA3L',       w:4961,h:3508, cat:'Print'},
  {k:'rpA3P',       w:3508,h:4961, cat:'Print'},
  // Square
  {k:'rpSq1k',      w:1000,h:1000, cat:'Square'},
  {k:'rpSq2k',      w:2000,h:2000, cat:'Square'},
  {k:'rpSq4k',      w:4000,h:4000, cat:'Square'},
];
function buildRes(){
  const cats=[...new Set(RP.map(r=>r.cat))];
  document.getElementById('rp-list').innerHTML=cats.map(cat=>{
    const items=RP.filter(r=>r.cat===cat);
    return`<div class="rp-cat-hd">${cat}</div>`+
      items.map(r=>`
        <div class="rp-item${rw===r.w&&rh===r.h?' active':''}" onclick="pickRP(this,${r.w},${r.h})">
          <span class="rp-name">${tr(r.k)}</span><span class="rp-dim">${r.w} × ${r.h}</span>
        </div>`).join('');
  }).join('');
}
function pickRP(el,w,h){
  document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('active'));
  el.classList.add('active');rw=w;rh=h;
  document.getElementById('rw').value=w;document.getElementById('rh').value=h;buildInfo();
}
function onResChange(){
  rw=+document.getElementById('rw').value||1080;
  rh=+document.getElementById('rh').value||1080;
  document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('active'));buildInfo();
}

/* ══════════════════════════════════
   RGB Curve
══════════════════════════════════ */
function setCurveCh(btn,ch){
  document.querySelectorAll('.curve-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');curveCh=ch;drawCurve();
}

function drawCurve(){
  const cv=document.getElementById('curve-canvas');if(!cv)return;
  // Sync canvas pixel dimensions to CSS display size (fixes blurry/wrong coords)
  const dpr=window.devicePixelRatio||1;
  const rect=cv.getBoundingClientRect();
  const W=Math.round(rect.width*dpr)||560;
  const H=Math.round(rect.height*dpr)||360;
  if(cv.width!==W||cv.height!==H){cv.width=W;cv.height=H}
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  // bg
  ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,W,H);
  // grid
  ctx.strokeStyle='#1e1e1e';ctx.lineWidth=dpr;
  for(let i=1;i<4;i++){
    const x=W*i/4,y=H*i/4;
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
  }
  // identity line
  ctx.strokeStyle='#252525';ctx.lineWidth=dpr;
  ctx.beginPath();ctx.moveTo(0,H);ctx.lineTo(W,0);ctx.stroke();
  // curve
  const pts=curves[curveCh];
  const col={L:'#d0d0d0',R:'#cc3333',G:'#33aa44',B:'#3366cc'}[curveCh];
  ctx.strokeStyle=col;ctx.lineWidth=2*dpr;
  ctx.beginPath();
  pts.forEach(([x,y],i)=>{
    const px=x*W,py=(1-y)*H;
    i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);
  });
  ctx.stroke();
  // points
  pts.forEach(([x,y])=>{
    ctx.fillStyle=col;
    ctx.beginPath();ctx.arc(x*W,(1-y)*H,5*dpr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=1.5*dpr;ctx.stroke();
  });
}

(function initCurveInteraction(){
  const cv=document.getElementById('curve-canvas');if(!cv)return;
  let dragging=null;
  function toNorm(e){
    const r=cv.getBoundingClientRect();
    const cx=e.touches?e.touches[0].clientX:e.clientX;
    const cy=e.touches?e.touches[0].clientY:e.clientY;
    // Use CSS rect (display pixels) for normalized [0,1] coords — matches drawCurve math
    return[Math.max(0,Math.min(1,(cx-r.left)/r.width)),Math.max(0,Math.min(1,1-(cy-r.top)/r.height))];
  }
  function nearest([x,y]){
    let bi=null,bd=Infinity;
    curves[curveCh].forEach(([px,py],i)=>{
      const d=Math.hypot(px-x,py-y);
      if(d<bd){bd=d;bi=i}
    });
    return bd<0.1?bi:null;
  }
  cv.addEventListener('pointerdown',e=>{
    cv.setPointerCapture(e.pointerId);
    const nm=toNorm(e);
    let idx=nearest(nm);
    if(idx===null){curves[curveCh].push(nm);curves[curveCh].sort((a,b)=>a[0]-b[0]);idx=curves[curveCh].findIndex(([x,y])=>x===nm[0]&&y===nm[1])}
    dragging=idx;drawCurve();e.preventDefault();
  },{passive:false});
  cv.addEventListener('pointermove',e=>{
    if(dragging===null)return;
    const nm=toNorm(e);
    curves[curveCh][dragging]=nm;
    curves[curveCh].sort((a,b)=>a[0]-b[0]);
    dragging=curves[curveCh].findIndex(([x,y])=>x===nm[0]&&y===nm[1]);
    drawCurve();scheduleRender();
  },{passive:true});
  cv.addEventListener('pointerup',()=>{dragging=null});
  cv.addEventListener('dblclick',e=>{
    const nm=toNorm(e),idx=nearest(nm);
    if(idx!==null&&curves[curveCh].length>2){curves[curveCh].splice(idx,1);drawCurve();scheduleRender()}
  });
})();

/* ══════════════════════════════════
   Presets
══════════════════════════════════ */
function showPI(){document.getElementById('pi-box').style.display='block';setTimeout(()=>document.getElementById('pi-name').focus(),30)}
function hidePI(){document.getElementById('pi-box').style.display='none';document.getElementById('pi-name').value=''}
function savePreset(){
  const n=document.getElementById('pi-name').value.trim();if(!n)return;
  presets.push({id:Date.now(),name:n,adj:{...adj},curves:JSON.parse(JSON.stringify(curves)),rot:rotDeg,fH,fV});
  localStorage.setItem('lens_v7',JSON.stringify(presets));hidePI();buildPresets();
}
function delPreset(id){presets=presets.filter(p=>p.id!==id);localStorage.setItem('lens_v7',JSON.stringify(presets));buildPresets()}
function applyPreset(id){
  const p=presets.find(x=>x.id===id);if(!p)return;
  adj={...p.adj};if(p.curves)Object.assign(curves,JSON.parse(JSON.stringify(p.curves)));
  rotDeg=p.rot||0;fH=!!p.fH;fV=!!p.fV;
  buildAllSliders();scheduleRender();drawCurve();sw('tone');
}
function buildPresets(){
  const el=document.getElementById('preset-list');
  if(!presets.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-ring"><div class="empty-ring-dot"></div></div><div class="empty-ttl">${tr('noPresets')}</div><div class="empty-sub">${tr('noPresetsSub')}</div></div>`;return;
  }
  el.innerHTML=presets.map(p=>{
    const meta=Object.entries(p.adj).filter(([,v])=>v!==0).slice(0,3).map(([k,v])=>`${k}:${v>0?'+':''}${v}`).join(' · ')||'DEFAULT';
    return`<div class="preset-card">
      <div class="pc-info"><div class="pc-name">${p.name}</div><div class="pc-meta">${meta}</div></div>
      <button class="apply-btn" onclick="applyPreset(${p.id})">${tr('applyBtn')}</button>
      <button class="del-btn" onclick="delPreset(${p.id})">${tr('deleteBtn')}</button>
    </div>`;
  }).join('');
}

/* ══════════════════════════════════
   Info
══════════════════════════════════ */
function toggleInfoSec(id){
  document.getElementById('is-hd-'+id).classList.toggle('open');
  document.getElementById('is-bd-'+id).classList.toggle('open');
}
function buildInfo(){
  const el=document.getElementById('info-body');if(!imgMeta)return;
  const rows=[
    ['infoFile',imgMeta.name,false],['infoSize',imgMeta.size,false],['infoType',imgMeta.type,false],
    ['infoW',imgMeta.w+' px',false],['infoH',imgMeta.h+' px',false],
    ['infoMP',imgMeta.mp+' MP',true],['infoAR',imgMeta.ar+' : 1',false],
    ['infoOutW',rw+' px',false],['infoOutH',rh+' px',false],
  ];
  const active=Object.entries(adj).filter(([,v])=>v!==0);
  el.innerHTML=
    rows.map(([k,v,hi])=>`<div class="info-r"><span class="info-k">${tr(k)}</span><span class="info-v${hi?' hi':''}">${v}</span></div>`).join('')+
    `<div class="info-sec">
      <div class="info-sec-hd" id="is-hd-tech" onclick="toggleInfoSec('tech')">
        <span class="info-sec-title">${tr('detailTitle')}</span><span class="info-chevron">▾</span>
      </div>
      <div class="info-sec-body" id="is-bd-tech">
        <div class="idr"><span class="idk">${tr('infoCS')}</span><span class="idv">sRGB</span></div>
        <div class="idr"><span class="idk">${tr('infoDP')}</span><span class="idv">8-bit</span></div>
        <div class="idr"><span class="idk">${tr('infoTP')}</span><span class="idv">${imgMeta.totalPx}</span></div>
        <div class="idr"><span class="idk">ROTATION</span><span class="idv">${rotDeg}°${fH?' FH':''}${fV?' FV':''}</span></div>
      </div>
    </div>
    <div class="info-sec">
      <div class="info-sec-hd" id="is-hd-adj" onclick="toggleInfoSec('adj')">
        <span class="info-sec-title">${tr('adjTitle')}</span><span class="info-chevron">▾</span>
      </div>
      <div class="info-sec-body" id="is-bd-adj">
        ${active.length?active.map(([k,v])=>`<div class="idr"><span class="idk">${k}</span><span class="idv r">${v>0?'+':''}${v}</span></div>`).join(''):`<div class="idr"><span class="idk">${tr('noneAdj')}</span></div>`}
      </div>
    </div>`;
}

/* ══════════════════════════════════
   Export
══════════════════════════════════ */
function openModal(){if(!srcImg)return;document.getElementById('exp-modal').classList.add('open')}
function closeModal(){document.getElementById('exp-modal').classList.remove('open')}
function pickFmt(el,fmt){
  document.querySelectorAll('.fmt-opt').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');exportFmt=fmt;
}
function doExport(){
  if(!srcImg)return;
  const cv=document.getElementById('offscreen');
  cv.width=rw;cv.height=rh;
  const ctx=cv.getContext('2d');
  const transparent=exportFmt==='transparent';
  if(!transparent){ctx.fillStyle='#fff';ctx.fillRect(0,0,rw,rh)}
  ctx.save();
  ctx.translate(rw/2,rh/2);
  const a=(rotDeg+adj.angle)*Math.PI/180;
  if(a)ctx.rotate(a);
  if(fH)ctx.scale(-1,1);if(fV)ctx.scale(1,-1);
  const b=1+adj.brightness/100,c=Math.max(0.01,1+adj.contrast/100),s=Math.max(0,1+adj.saturation/100);
  const blr=adj.blur>0?`blur(${(adj.blur*0.25).toFixed(2)}px)`:'';
  const hr=adj.hue?`hue-rotate(${adj.hue}deg)`:'';
  ctx.filter=[`brightness(${b})`,`contrast(${c})`,`saturate(${s})`,blr,hr].filter(Boolean).join(' ');
  ctx.drawImage(srcImg,-rw/2,-rh/2,rw,rh);
  ctx.restore();ctx.filter='none';
  if(adj.vignette>0&&!transparent){
    const vg=ctx.createRadialGradient(rw/2,rh/2,0,rw/2,rh/2,Math.hypot(rw,rh)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.6),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${adj.vignette/100*0.85})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,rw,rh);
  }
  if(adj.fade>0){ctx.fillStyle=`rgba(255,255,255,${adj.fade/100*0.38})`;ctx.fillRect(0,0,rw,rh)}
  if(adj.grain>0){
    const id=ctx.getImageData(0,0,rw,rh);const d=id.data;const g=adj.grain;
    for(let i=0;i<d.length;i+=4){const n=(Math.random()-.5)*g;d[i]=Math.max(0,Math.min(255,d[i]+n));d[i+1]=Math.max(0,Math.min(255,d[i+1]+n));d[i+2]=Math.max(0,Math.min(255,d[i+2]+n))}
    ctx.putImageData(id,0,0);
  }
  const mime=transparent||exportFmt==='png'?'image/png':exportFmt==='webp'?'image/webp':'image/jpeg';
  const ext=transparent||exportFmt==='png'?'png':exportFmt==='webp'?'webp':'jpg';
  const dlLink=document.createElement('a');
  dlLink.download=`lens_${Date.now()}.${ext}`;
  dlLink.href=cv.toDataURL(mime,mime==='image/jpeg'?.94:undefined);
  dlLink.click();closeModal();
}

/* ══════════════════════════════════
   Splash
══════════════════════════════════ */
function updSplash(){
  document.getElementById('sp-sub').textContent=tr('appSub');
  document.getElementById('sp-cta').textContent=tr('splashCta');
}
function dismissSplash(){
  const sp=document.getElementById('splash');
  sp.classList.add('out');
  setTimeout(()=>sp.remove(),550);
}

/* ══════════════════════════════════
   Responsive preview resize
══════════════════════════════════ */
new ResizeObserver(()=>{if(srcImg)scheduleRender()})
  .observe(document.getElementById('preview-area'));

/* ══════════════════════════════════
   Expose to global scope (needed for inline onclick)
══════════════════════════════════ */
window.toggleLang=toggleLang;
window.triggerOpen=triggerOpen;
window.openModal=openModal;
window.closeModal=closeModal;
window.pickFmt=pickFmt;
window.doExport=doExport;
window.sw=sw;
window.resetAdj=resetAdj;
window.setCurveCh=setCurveCh;
window.toggleSection=toggleSection;
window.doRotate=doRotate;
window.doFlipH=doFlipH;
window.doFlipV=doFlipV;
window.pickCrop=pickCrop;
window.onResChange=onResChange;
window.pickRP=pickRP;
window.showPI=showPI;
window.hidePI=hidePI;
window.savePreset=savePreset;
window.delPreset=delPreset;
window.applyPreset=applyPreset;
window.toggleInfoSec=toggleInfoSec;
window.openNumInput=openNumInput;
window.closeNumInput=closeNumInput;
window.numKey=numKey;
window.onFileLoad=onFileLoad;

/* ══════════════════════════════════
   Boot
══════════════════════════════════ */
buildAllSliders();buildRes();buildPresets();updSplash();
requestAnimationFrame(drawCurve);
document.getElementById('splash').addEventListener('click', dismissSplash);

})(); // end IIFE
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>LENS</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
/* â•â• RESET â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:#0a0a0a;color:#f0f0f0;font-family:'Nunito','Noto Sans JP',sans-serif;font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased;user-select:none}

/* â•â• VARIABLES â•â• */
:root{
  --bg:#0a0a0a;--s1:#111;--s2:#181818;--s3:#222;
  --b1:#1e1e1e;--b2:#2a2a2a;--b3:#363636;
  --t1:#f0f0f0;--t2:#a0a0a0;--t3:#555;
  --red:#c8000a;--reda:rgba(200,0,10,.15);
  --r:10px;--rs:7px;
  --ease:cubic-bezier(.22,1,.36,1);
  --split:40%;
}

/* â•â• SPLASH â•â• */
#splash{position:fixed;inset:0;z-index:9999;background:#0a0a0a;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer}
#splash.out{animation:spout .5s var(--ease) forwards;pointer-events:none}
@keyframes spout{to{opacity:0;transform:scale(1.04)}}
.sp-ring{width:80px;height:80px;border-radius:50%;border:1.5px solid var(--b3);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:28px;animation:rot 9s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}
.sp-ring::before{content:'';position:absolute;inset:10px;border-radius:50%;border:1px solid var(--b2);animation:rot 6s linear infinite reverse}
.sp-ring::after{content:'';position:absolute;inset:22px;border-radius:50%;border:1px solid var(--b1)}
.sp-dot{width:11px;height:11px;background:var(--red);border-radius:50%;animation:glow 3s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(200,0,10,.4)}50%{box-shadow:0 0 20px rgba(200,0,10,.9)}}
.sp-title{font-size:40px;font-weight:900;letter-spacing:10px;margin-bottom:6px}
.sp-sub{font-size:9.5px;font-weight:700;letter-spacing:4px;color:var(--t3);margin-bottom:44px}
.sp-cta{display:flex;align-items:center;gap:10px;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--t3);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:.3}55%{opacity:1}}
.sp-line{width:24px;height:1px;background:var(--b3)}

/* â•â• LAYOUT â•â• */
#app{display:flex;width:100%;height:100%;opacity:0;animation:fi .4s .05s ease forwards}
@keyframes fi{to{opacity:1}}

/* MOBILE: vertical stack */
@media(max-width:767px){
  #app{flex-direction:column}
  #left-pane{width:100%;flex-shrink:0;display:flex;flex-direction:column}
  #preview-area{height:clamp(180px,52vw,260px);flex-shrink:0}
  #right-pane{flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden}
  .tabs{overflow-x:auto;overflow-y:hidden;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
  .tabs::-webkit-scrollbar{display:none}
  .tab{flex:0 0 auto;min-width:54px}
  .panel{max-height:calc(100dvh - 52vw - 96px - 58px)}
  #split-handle{display:none!important}
}

/* DESKTOP: side by side */
@media(min-width:768px){
  #app{flex-direction:row}
  /* left pane: fixed width, full height, column layout */
  #left-pane{
    width:var(--split);
    flex-shrink:0;
    height:100%;
    display:flex;
    flex-direction:column;
    border-right:1px solid var(--b1);
    overflow:hidden;
  }
  /* preview fills remaining height in left pane */
  #preview-area{flex:1;min-height:0}
  /* right pane fills rest */
  #right-pane{flex:1;min-width:0;height:100%;display:flex;flex-direction:column;overflow:hidden}
  /* tabs vertical */
  .tabs{flex-direction:column;width:58px;flex-shrink:0;border-right:1px solid var(--b1);border-bottom:none;overflow-y:auto;scrollbar-width:none}
  .tabs::-webkit-scrollbar{display:none}
  .tab{padding:12px 4px;min-height:58px;border-bottom:none;border-right:2.5px solid transparent;flex:0 0 auto}
  .tab.active{border-right-color:var(--red);border-bottom-color:transparent}
  #editor-area{flex:1;display:flex;min-height:0;overflow:hidden}
  .panel-wrap{flex:1;min-width:0}
  .panel{max-height:100%}
  /* split handle */
  #split-handle{
    position:fixed;top:0;bottom:0;width:8px;
    cursor:col-resize;z-index:200
  }
  #split-handle::after{
    content:'';position:absolute;left:50%;top:50%;
    transform:translate(-50%,-50%);
    width:3px;height:44px;background:var(--b3);border-radius:4px;
    opacity:0;transition:opacity .18s
  }
  #split-handle:hover::after,#split-handle.drag::after{opacity:1}
}

/* â•â• HEADER â•â• */
header{
  display:flex;align-items:center;gap:6px;
  padding:9px 14px 8px 20px;
  border-bottom:1px solid var(--b1);
  background:var(--bg);flex-shrink:0
}
.logo{display:flex;align-items:center;gap:9px;cursor:pointer;flex-shrink:0;transition:opacity .15s;margin-right:auto}
.logo:hover{opacity:.7}
.hdr-dot{width:8px;height:8px;background:var(--red);border-radius:50%;animation:glow 3s ease-in-out infinite;flex-shrink:0}
.logo-n{font-size:19px;font-weight:900;letter-spacing:3px;line-height:1}
.logo-s{font-size:7.5px;font-weight:700;letter-spacing:3px;color:var(--t3);margin-top:1px}
/* mode toggle */
.mode-toggle{display:flex;background:var(--s1);border:1.5px solid var(--b2);border-radius:var(--rs);overflow:hidden;flex-shrink:0}
.mode-btn{padding:5px 9px;font-family:inherit;font-size:9.5px;font-weight:700;border:none;background:none;color:var(--t3);cursor:pointer;transition:all .15s;white-space:nowrap}
.mode-btn.on{background:var(--red);color:#fff}
.hbtn{background:var(--s2);border:1.5px solid var(--b2);color:var(--t2);font-family:inherit;font-size:10px;font-weight:700;padding:5px 9px;cursor:pointer;border-radius:var(--rs);transition:all .15s;white-space:nowrap;flex-shrink:0}
.hbtn:hover{border-color:var(--t3);color:var(--t1)}
.hbtn.red{background:var(--red);color:#fff;border-color:var(--red)}
.hbtn.red:hover{opacity:.88}

/* â•â• PREVIEW â•â• */
#preview-area{
  background:var(--s1);
  display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
  cursor:pointer;
  flex-shrink:0;
  border-bottom:1px solid var(--b1);
}
#preview-area.has-img{cursor:default}
#preview-area.dragover{outline:3px dashed var(--red);outline-offset:-8px;background:var(--reda)}
/* checkerboard = hidden until image loaded */
#checker{
  position:absolute;inset:0;pointer-events:none;display:none;
  background-image:
    linear-gradient(45deg,#1e1e1e 25%,transparent 25%),
    linear-gradient(-45deg,#1e1e1e 25%,transparent 25%),
    linear-gradient(45deg,transparent 75%,#1e1e1e 75%),
    linear-gradient(-45deg,transparent 75%,#1e1e1e 75%);
  background-size:14px 14px;
  background-position:0 0,0 7px,7px -7px,-7px 0;
}
#prev-cv{display:none;max-width:100%;max-height:100%;position:relative;z-index:1}
.ph-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;pointer-events:none;z-index:1}
.ph-ring{width:52px;height:52px;border:1.5px solid var(--b3);border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative}
.ph-ring::before{content:'';position:absolute;inset:8px;border:1px solid var(--b2);border-radius:50%}
.ph-ring::after{content:'';position:absolute;inset:17px;border:1px solid var(--b2);border-radius:50%}
.ph-dot{width:6px;height:6px;background:var(--red);border-radius:50%}
.ph-txt{font-size:9.5px;font-weight:700;letter-spacing:2.5px;color:var(--t3);text-align:center;line-height:1.6}
.exp-bar{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--b1)}
.exp-fill{height:100%;background:var(--red);width:50%;transition:width .1s}

/* â•â• TABS â•â• */
.tabs{display:flex;background:var(--bg);border-bottom:1px solid var(--b1);flex-shrink:0}
.tab{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:8px 2px 7px;border:none;background:none;
  color:var(--t3);font-family:inherit;font-size:8px;font-weight:700;
  letter-spacing:.5px;cursor:pointer;gap:3px;
  border-bottom:2px solid transparent;
  transition:color .15s,border-color .15s
}
.tab.active{color:var(--t1);border-bottom-color:var(--red)}
.tab svg{width:14px;height:14px;opacity:.55;transition:opacity .15s;flex-shrink:0}
.tab.active svg{opacity:1}
.tab span{font-size:6.5px;white-space:nowrap;line-height:1}

/* â•â• PANELS â•â• */
.panel-wrap{flex:1;overflow:hidden;min-height:0;position:relative}
.panel{display:none;padding:14px 16px 44px;overflow-y:auto;height:100%;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}
.panel.on{display:block;animation:pin .18s var(--ease)}
@keyframes pin{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.pnl-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.pnl-ttl{font-size:8.5px;font-weight:800;letter-spacing:3px;color:var(--t3)}

/* â•â• SECTIONS â•â• */
.sec{margin-bottom:2px}
.sec-hd{display:flex;align-items:center;justify-content:space-between;padding:9px 0 8px;border-bottom:1px solid var(--b1);margin-bottom:10px}
.sec-hd.click{cursor:pointer}
.sec-hd.click:hover .sec-ttl{color:var(--t2)}
.sec-ttl{display:flex;align-items:center;gap:7px;font-size:8.5px;font-weight:800;letter-spacing:2px;color:var(--t3);transition:color .15s}
.sec-bar{width:3px;height:10px;background:var(--red);border-radius:2px;flex-shrink:0}
.sec-arr{font-size:10px;color:var(--t3);transition:transform .2s var(--ease)}
.sec.closed .sec-arr{transform:rotate(-90deg)}
.sec-body{overflow:hidden;transition:max-height .26s var(--ease),opacity .2s;max-height:3000px;opacity:1}
.sec.closed .sec-body{max-height:0!important;opacity:0}

/* â•â• PRO SLIDER â•â• */
.sl-row{margin-bottom:14px}
.sl-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.sl-lbl{font-size:11.5px;font-weight:700;color:var(--t2)}
.sl-val{font-size:12px;font-weight:800;color:var(--t3);font-variant-numeric:tabular-nums;cursor:pointer;padding:2px 5px;border-radius:5px;transition:color .12s,background .12s;position:relative}
.sl-val.nz{color:var(--red)}
.sl-val:hover{background:var(--s2)}
.sl-inp{
  position:absolute;right:0;top:-3px;width:58px;height:24px;
  background:var(--s2);border:1.5px solid var(--red);
  color:var(--t1);font-family:inherit;font-size:12px;font-weight:800;
  text-align:right;padding:0 6px;border-radius:5px;outline:none;display:none;z-index:20
}
.sl-hit{position:relative;height:34px;display:flex;align-items:center;touch-action:none;cursor:ew-resize}
.sl-bg{position:absolute;left:0;right:0;height:3px;background:var(--s3);border-radius:2px;pointer-events:none}
.sl-fill{position:absolute;height:3px;background:var(--red);border-radius:2px;pointer-events:none}
.sl-mid{position:absolute;left:50%;top:0;width:1px;height:3px;background:var(--b3);transform:translateX(-50%);pointer-events:none}
.sl-knob{position:absolute;width:16px;height:16px;background:var(--bg);border:2.5px solid var(--red);border-radius:50%;transform:translate(-50%,-50%);top:50%;pointer-events:none;box-shadow:0 2px 6px rgba(0,0,0,.6);will-change:left}
.sl-hit.drag .sl-knob{box-shadow:0 0 0 6px var(--reda);transform:translate(-50%,-50%) scale(1.1);transition:transform .1s,box-shadow .1s}

/* â•â• EASY SLIDER (larger) â•â• */
.ec{background:var(--s1);border:1.5px solid var(--b1);border-radius:12px;padding:14px 14px 12px;margin-bottom:10px}
.ec-hd{display:flex;align-items:center;gap:8px;margin-bottom:3px}
.ec-ico{font-size:17px}
.ec-ttl{font-size:12.5px;font-weight:800;color:var(--t1)}
.ec-sub{font-size:9.5px;color:var(--t3);font-weight:600;margin-bottom:12px}
.es-hit{position:relative;height:40px;display:flex;align-items:center;touch-action:none;cursor:ew-resize}
.es-bg{position:absolute;left:0;right:0;height:5px;background:var(--s3);border-radius:3px;pointer-events:none}
.es-fill{position:absolute;height:5px;border-radius:3px;pointer-events:none;background:linear-gradient(90deg,var(--red),#ff3355)}
.es-mid{position:absolute;left:50%;top:0;width:2px;height:5px;background:var(--b3);transform:translateX(-50%);pointer-events:none}
.es-knob{position:absolute;width:24px;height:24px;background:#fff;border:3px solid var(--red);border-radius:50%;transform:translate(-50%,-50%);top:50%;pointer-events:none;box-shadow:0 2px 10px rgba(0,0,0,.65);will-change:left}
.es-hit.drag .es-knob{box-shadow:0 0 0 8px var(--reda);transform:translate(-50%,-50%) scale(1.1);transition:transform .1s,box-shadow .1s}
.es-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.es-lbl{font-size:11px;font-weight:700;color:var(--t2)}
.es-val{font-size:12px;font-weight:800;color:var(--t3);font-variant-numeric:tabular-nums}
.es-val.nz{color:var(--red)}

/* â•â• FILTER GRID â•â• */
.fg{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px}
.fg-cat{font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);grid-column:1/-1;margin-top:8px;padding-bottom:4px;border-bottom:1px solid var(--b1)}
.fg-cat:first-child{margin-top:0}
.fc{background:var(--s2);border:1.5px solid var(--b2);border-radius:10px;padding:10px 4px;cursor:pointer;text-align:center;transition:all .14s;position:relative;overflow:hidden}
.fc:hover{border-color:var(--b3);background:var(--s3)}
.fc.on{border-color:var(--red);background:var(--reda)}
.fc::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--red);transform:scaleX(0);transform-origin:left;transition:transform .18s var(--ease)}
.fc.on::after{transform:scaleX(1)}
.fi{font-size:20px;margin-bottom:3px}
.fn{font-size:9px;font-weight:800;color:var(--t2);line-height:1.2}
.fc.on .fn{color:var(--t1)}

/* â•â• MISC COMPONENTS â•â• */
.ghost{background:none;border:1.5px solid var(--b2);color:var(--t2);font-size:10.5px;font-weight:700;padding:7px 12px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:all .14s}
.ghost:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.solid{background:var(--red);color:#fff;border:none;font-size:10.5px;font-weight:700;padding:8px 16px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:opacity .14s,transform .1s}
.solid:active{opacity:.85;transform:scale(.97)}
.divider{height:1px;background:var(--b1);margin:12px 0}
.inp-lbl{font-size:8.5px;font-weight:700;letter-spacing:1.5px;color:var(--t3);margin-bottom:5px}
input[type=number],input[type=text]{background:var(--s1);border:1.5px solid var(--b1);color:var(--t1);padding:9px 11px;font-size:12.5px;font-weight:600;font-family:inherit;width:100%;outline:none;border-radius:var(--rs);transition:border-color .14s}
input:focus{border-color:var(--red)}
input::placeholder{color:var(--t3)}

/* â•â• CROP â•â• */
.crop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.crop-card{border:1.5px solid var(--b1);background:var(--s1);padding:12px 14px 10px;cursor:pointer;border-radius:var(--r);overflow:hidden;position:relative;transition:all .14s}
.crop-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2.5px;background:var(--red);transform:scaleX(0);transform-origin:left;transition:transform .2s var(--ease)}
.crop-card.on{background:var(--s2);border-color:var(--b2)}
.crop-card.on::after{transform:scaleX(1)}
.crop-ratio{font-size:14px;font-weight:900;color:var(--t2);margin-bottom:2px}
.crop-card.on .crop-ratio{color:var(--t1)}
.crop-nm{font-size:9px;font-weight:700;color:var(--t3);letter-spacing:.5px}

/* â•â• ROTATE â•â• */
.rot-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.rot-btn{background:var(--s1);border:1.5px solid var(--b1);color:var(--t2);font-size:11px;font-weight:700;padding:12px 8px;cursor:pointer;font-family:inherit;border-radius:var(--r);display:flex;align-items:center;justify-content:center;gap:6px;transition:all .14s}
.rot-btn:hover{background:var(--s2);border-color:var(--b2);color:var(--t1)}
.rot-btn:active{transform:scale(.96)}
.ri{font-size:16px}

/* â•â• MOSAIC â•â• */
.mos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.mos-card{border:1.5px solid var(--b1);background:var(--s1);border-radius:var(--r);padding:12px 8px;text-align:center;cursor:pointer;transition:all .14s}
.mos-card.on{border-color:var(--red);background:var(--reda)}
.mos-sz{font-size:14px;font-weight:900;color:var(--t2)}
.mos-card.on .mos-sz{color:var(--t1)}
.mos-lbl{font-size:9px;color:var(--t3);font-weight:700}

/* â•â• RESOLUTION â•â• */
.res-row{display:flex;align-items:flex-end;gap:10px;margin-bottom:12px}
.res-x{color:var(--t3);font-size:16px;padding-bottom:8px}
.res-iw{flex:1}
.rp-cat{font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);margin-top:10px;margin-bottom:3px;padding-bottom:4px;border-bottom:1px solid var(--b1)}
.rp-cat:first-child{margin-top:0}
.rp-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1.5px solid var(--b1);border-radius:var(--r);background:var(--s1);cursor:pointer;position:relative;overflow:hidden;transition:all .14s;margin-bottom:4px}
.rp-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);transform:scaleY(0);transform-origin:bottom;border-radius:0 2px 2px 0;transition:transform .18s var(--ease)}
.rp-item.on{background:var(--s2);border-color:var(--b2)}
.rp-item.on::before{transform:scaleY(1)}
.rp-nm{font-size:12px;font-weight:700;color:var(--t2)}
.rp-item.on .rp-nm{color:var(--t1)}
.rp-dim{font-size:10px;color:var(--t3)}

/* â•â• RGB CURVE â•â• */
.cv-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:11px;margin-bottom:12px}
.cv-tabs{display:flex;gap:4px;margin-bottom:9px}
.cv-tab{flex:1;padding:5px 4px;border:1.5px solid var(--b2);background:none;font-family:inherit;font-size:9.5px;font-weight:700;cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all .14s}
.cv-tab.on{color:#fff}
.cv-tab[data-ch=L].on{background:var(--s3);border-color:var(--b3)}
.cv-tab[data-ch=R].on{background:#8b0000;border-color:#8b0000}
.cv-tab[data-ch=G].on{background:#005500;border-color:#005500}
.cv-tab[data-ch=B].on{background:#00008b;border-color:#00008b}
#cv-canvas{width:100%;height:160px;display:block;border-radius:5px;cursor:crosshair;touch-action:none}

/* â•â• HISTOGRAM â•â• */
.ht-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:11px;margin-bottom:12px}
.ht-tabs{display:flex;gap:4px;margin-bottom:9px}
.ht-tab{flex:1;padding:4px;border:1.5px solid var(--b2);background:none;font-family:inherit;font-size:9px;font-weight:700;cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all .14s}
.ht-tab.on{background:var(--s3);border-color:var(--b3);color:var(--t1)}
#ht-canvas{width:100%;height:80px;display:block;border-radius:4px}

/* â•â• HSL â•â• */
.hsl-cr{margin-bottom:13px}
.hsl-hd{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.hsl-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0}
.hsl-nm{font-size:11px;font-weight:700;color:var(--t2)}
.hsl-sub{display:grid;grid-template-columns:24px 1fr 36px;align-items:center;gap:6px;margin-bottom:5px}
.hsl-sl{font-size:8.5px;font-weight:700;color:var(--t3);text-align:center}
.hsl-v{font-size:11px;font-weight:800;color:var(--t3);text-align:right;font-variant-numeric:tabular-nums}
.hsl-v.nz{color:var(--red)}

/* â•â• PRESETS â•â• */
.pi-box{background:var(--s1);border:1.5px solid var(--b1);padding:13px;margin-bottom:12px;border-radius:var(--r);animation:pin .18s var(--ease)}
.pi-btns{display:flex;gap:7px;margin-top:9px}
.pc{display:flex;align-items:center;gap:9px;border:1.5px solid var(--b1);background:var(--s1);padding:11px 12px;margin-bottom:7px;border-radius:var(--r);transition:all .14s;animation:pin .18s var(--ease)}
.pc:hover{border-color:var(--b2);background:var(--s2)}
.pc.builtin{border-left:3px solid var(--red)}
.pc-info{flex:1;min-width:0}
.pc-nm{font-size:13px;font-weight:700;color:var(--t1);margin-bottom:2px}
.pc-meta{font-size:9px;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.app-btn{background:var(--red);color:#fff;border:none;font-size:9.5px;font-weight:700;padding:7px 11px;cursor:pointer;font-family:inherit;border-radius:var(--rs);white-space:nowrap}
.del-btn{border:1.5px solid var(--b2);background:none;color:var(--t3);font-size:12px;padding:6px 10px;cursor:pointer;border-radius:var(--rs);transition:all .14s}
.del-btn:hover{border-color:var(--red);color:var(--red)}

/* â•â• INFO â•â• */
.info-r{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--b1);gap:10px}
.info-k{font-size:9px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.info-v{font-size:11px;font-weight:600;color:var(--t2);text-align:right;word-break:break-all}
.info-v.hi{color:var(--red)}
.info-sec{margin-top:8px}
.info-sh{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);cursor:pointer;margin-bottom:3px;transition:background .14s}
.info-sh:hover{background:var(--s2)}
.info-sh.op{border-radius:var(--r) var(--r) 0 0;margin-bottom:0}
.info-st{font-size:10.5px;font-weight:700;color:var(--t2)}
.info-ch{font-size:10px;color:var(--t3);transition:transform .2s var(--ease)}
.info-sh.op .info-ch{transform:rotate(180deg)}
.info-sb{background:var(--s1);border:1.5px solid var(--b2);border-top:none;border-radius:0 0 var(--r) var(--r);padding:0 12px;overflow:hidden;max-height:0;transition:max-height .28s var(--ease);margin-bottom:4px}
.info-sb.op{max-height:600px;padding:2px 12px 9px}
.idr{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b1);gap:8px}
.idr:last-child{border-bottom:none}
.idk{font-size:8.5px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.idv{font-size:10px;font-weight:600;color:var(--t2);text-align:right}
.idv.r{color:var(--red)}

/* â•â• EMPTY â•â• */
.empty{text-align:center;padding:40px 0}
.e-ring{width:44px;height:44px;border:1.5px solid var(--b2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px}
.e-dot{width:4px;height:4px;background:var(--b2);border-radius:50%}
.e-ttl{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--t3);margin-bottom:5px}
.e-sub{font-size:9.5px;color:#252525;letter-spacing:.5px}

/* â•â• BOTTOM BAR â•â• */
#bot{display:none;gap:8px;padding:10px 14px;border-top:1px solid var(--b1);background:var(--bg);flex-shrink:0}
.rst{flex:1;border:1.5px solid var(--b2);background:none;color:var(--t2);padding:12px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:all .14s}
.rst:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.exp-b{flex:2;background:var(--red);color:#fff;border:none;padding:12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:opacity .14s,transform .1s}
.exp-b:active{opacity:.85;transform:scale(.98)}

/* â•â• MODAL â•â• */
.overlay{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.78);display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px)}
.overlay.op{display:flex;animation:mfade .22s ease}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.sheet{background:var(--s1);border:1.5px solid var(--b2);border-radius:var(--r) var(--r) 0 0;padding:18px 18px 36px;width:100%;max-width:480px;animation:shup .26s var(--ease)}
@keyframes shup{from{transform:translateY(32px)}to{transform:none}}
.modal-ttl{font-size:12px;font-weight:800;letter-spacing:2.5px;color:var(--t2);margin-bottom:13px}
.fmt-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:13px}
.fmt-opt{border:1.5px solid var(--b2);background:var(--s2);padding:12px;border-radius:var(--rs);cursor:pointer;text-align:center;transition:all .14s}
.fmt-opt.on{border-color:var(--red);background:var(--reda)}
.fmt-nm{font-size:11px;font-weight:700;color:var(--t2)}
.fmt-opt.on .fmt-nm{color:var(--t1)}
.fmt-sub{font-size:9px;color:var(--t3);margin-top:2px}
.modal-btns{display:flex;gap:8px}

/* â•â• CONFIRM â•â• */
#confirm{position:fixed;inset:0;z-index:9800;background:rgba(0,0,0,.82);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
#confirm.op{display:flex;animation:mfade .2s ease}
.confirm-box{background:var(--s1);border:1.5px solid var(--b2);border-radius:14px;padding:28px 22px;max-width:300px;width:90%;text-align:center}
.confirm-ico{font-size:30px;margin-bottom:10px}
.confirm-ttl{font-size:15px;font-weight:800;color:var(--t1);margin-bottom:8px}
.confirm-sub{font-size:11.5px;color:var(--t2);margin-bottom:22px;line-height:1.6}
.confirm-btns{display:flex;gap:10px}
.c-ok{flex:1;background:var(--red);color:#fff;border:none;padding:12px;font-size:12px;font-weight:700;border-radius:var(--rs);cursor:pointer;font-family:inherit}
.c-no{flex:1;background:none;border:1.5px solid var(--b2);color:var(--t2);padding:12px;font-size:12px;font-weight:700;border-radius:var(--rs);cursor:pointer;font-family:inherit}

/* â•â• SCROLLBAR â•â• */
::-webkit-scrollbar{width:2px;height:2px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--b3);border-radius:2px}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-ring"><div class="sp-dot"></div></div>
  <div class="sp-title">LENS</div>
  <div class="sp-sub" id="sp-sub">ãƒ•ã‚©ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</div>
  <div class="sp-cta"><div class="sp-line"></div><span id="sp-cta">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</span><div class="sp-line"></div></div>
</div>

<!-- APP -->
<div id="app">

  <!-- LEFT PANE -->
  <div id="left-pane">
    <header>
      <div class="logo" onclick="goHome()">
        <div class="hdr-dot"></div>
        <div>
          <div class="logo-n">LENS</div>
          <div class="logo-s" id="hdr-sub">PHOTO EDITOR</div>
        </div>
      </div>
      <div class="mode-toggle">
        <button class="mode-btn" id="mb-easy" onclick="setMode('easy')" id="mb-easy">ã‹ã‚“ãŸã‚“</button>
        <button class="mode-btn on" id="mb-pro" onclick="setMode('pro')">PRO</button>
      </div>
      <button class="hbtn" id="lang-btn" onclick="toggleLang()">EN</button>
      <button class="hbtn" id="open-btn" onclick="triggerOpen()">é–‹ã</button>
      <button class="hbtn red" id="exp-hbtn" style="display:none" onclick="openModal()">æ›¸ãå‡ºã™</button>
      <input id="fi" type="file" accept="image/*" style="display:none" onchange="onFI(event)"/>
    </header>

    <div id="preview-area" onclick="onPreviewClick()">
      <div id="checker"></div>
      <div class="ph-wrap" id="ph">
        <div class="ph-ring"><div class="ph-dot"></div></div>
        <div class="ph-txt" id="ph-txt">ã‚¿ãƒƒãƒ—ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦<br>å†™çœŸã‚’é–‹ã</div>
      </div>
      <canvas id="prev-cv"></canvas>
      <div class="exp-bar"><div class="exp-fill" id="exp-fill"></div></div>
    </div>

    <div id="split-handle"></div>
  </div>

  <!-- RIGHT PANE -->
  <div id="right-pane">
    <div id="editor-area">

      <!-- TABS -->
      <nav class="tabs" id="tabs">
        <!-- easy -->
        <button class="tab" data-tab="efilter" data-m="easy" onclick="sw('efilter')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2l1.5 3 3.5.5-2.5 2.5.6 3.5L8 10l-3.1 1.5.6-3.5L3 5.5l3.5-.5z"/></svg>
          <span>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</span>
        </button>
        <button class="tab" data-tab="eadj" data-m="easy" onclick="sw('eadj')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><line x1="8" y1="3" x2="8" y2="13"/><line x1="3" y1="8" x2="13" y2="8"/></svg>
          <span>èª¿æ•´</span>
        </button>
        <!-- pro -->
        <button class="tab" data-tab="tone" data-m="pro" onclick="sw('tone')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5"/><line x1="8" y1="3" x2="8" y2="13"/></svg>
          <span>ãƒˆãƒ¼ãƒ³</span>
        </button>
        <button class="tab" data-tab="color" data-m="pro" onclick="sw('color')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2a6 6 0 100 12A6 6 0 008 2z"/><path d="M8 2c2 2 2 8 0 12M8 2C6 4 6 10 8 14"/></svg>
          <span>ã‚«ãƒ©ãƒ¼</span>
        </button>
        <button class="tab" data-tab="detail" data-m="pro" onclick="sw('detail')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8h10M8 3v10M4.5 4.5l7 7M11.5 4.5l-7 7"/></svg>
          <span>è©³ç´°</span>
        </button>
        <button class="tab" data-tab="xform" data-m="pro" onclick="sw('xform')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 3L2 8l3 5M11 3l3 5-3 5"/><line x1="2" y1="8" x2="14" y2="8"/></svg>
          <span>å¤‰å½¢</span>
        </button>
        <!-- shared -->
        <button class="tab" data-tab="cut" onclick="sw('cut')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="10" height="10" rx="1"/><line x1="3" y1="7" x2="13" y2="7"/><line x1="7" y1="3" x2="7" y2="13"/></svg>
          <span>ã‚«ãƒƒãƒˆ</span>
        </button>
        <button class="tab" data-tab="mosaic" data-m="pro" onclick="sw('mosaic')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg>
          <span>ãƒ¢ã‚¶ã‚¤ã‚¯</span>
        </button>
        <button class="tab" data-tab="size" data-m="pro" onclick="sw('size')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="8" height="8" rx="1"/><rect x="6" y="2" width="8" height="8" rx="1"/></svg>
          <span>ã‚µã‚¤ã‚º</span>
        </button>
        <button class="tab" data-tab="preset" onclick="sw('preset')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8a4 4 0 108 0 4 4 0 00-8 0z"/><path d="M8 5v3l2 2"/></svg>
          <span>ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
        </button>
        <button class="tab" data-tab="info" data-m="pro" onclick="sw('info')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><line x1="8" y1="7" x2="8" y2="11"/><circle cx="8" cy="5" r=".5" fill="currentColor"/></svg>
          <span>æƒ…å ±</span>
        </button>
      </nav>

      <!-- PANELS -->
      <div class="panel-wrap">

        <!-- EASY FILTER -->
        <div class="panel" id="panel-efilter">
          <div class="pnl-hd"><div class="pnl-ttl">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ &amp; ãƒ«ãƒƒã‚¯</div></div>
          <!-- Cheki quick section -->
          <div style="background:linear-gradient(135deg,#1a1a1a,#222);border:1.5px solid #2a2a2a;border-radius:12px;padding:14px;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <span style="font-size:20px">ğŸ“·</span>
              <div>
                <div style="font-size:13px;font-weight:800;color:#f0f0f0">ãƒã‚§ã‚­é¢¨ã«ä»•ä¸Šã’ã‚‹</div>
                <div style="font-size:9.5px;color:#555;margin-top:2px">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆãƒ•ã‚©ãƒˆé¢¨ã®ãµã‚“ã‚ã‚ŠåŠ å·¥</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
              <button onclick="applyCheki('soft')" style="background:#1e1e1e;border:1.5px solid #333;color:#ccc;font-size:9.5px;font-weight:700;padding:9px 4px;border-radius:8px;cursor:pointer;font-family:inherit">ğŸŒ¸ ã‚½ãƒ•ãƒˆ</button>
              <button onclick="applyCheki('warm')" style="background:#1e1e1e;border:1.5px solid #333;color:#ccc;font-size:9.5px;font-weight:700;padding:9px 4px;border-radius:8px;cursor:pointer;font-family:inherit">â˜€ï¸ ã‚¦ã‚©ãƒ¼ãƒ </button>
              <button onclick="applyCheki('cool')" style="background:#1e1e1e;border:1.5px solid #333;color:#ccc;font-size:9.5px;font-weight:700;padding:9px 4px;border-radius:8px;cursor:pointer;font-family:inherit">ğŸ§Š ã‚¯ãƒ¼ãƒ«</button>
            </div>
          </div>
          <div class="fg" id="filter-grid"></div>
          <div class="pnl-ttl" style="margin-bottom:10px">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¼·ã•</div>
          <div id="filt-intensity"></div>
        </div>

        <!-- EASY ADJ -->
        <div class="panel" id="panel-eadj">
          <div class="pnl-hd">
            <div class="pnl-ttl">ã‹ã‚“ãŸã‚“èª¿æ•´</div>
            <button class="ghost" data-i18n="reset" onclick="resetAdj()">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div id="easy-cards"></div>
        </div>

        <!-- PRO TONE -->
        <div class="panel on" id="panel-tone">
          <div class="pnl-hd">
            <div class="pnl-ttl">ãƒˆãƒ¼ãƒ³ãƒ»éœ²å…‰</div>
            <button class="ghost" data-i18n="reset" onclick="resetAdj()">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div id="sl-tone"></div>
          <!-- Histogram -->
          <div class="sec">
            <div class="sec-hd click" onclick="toggleSec(this)">
              <div class="sec-ttl"><div class="sec-bar"></div><span>ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </span></div>
              <span class="sec-arr">â–¾</span>
            </div>
            <div class="sec-body">
              <div class="ht-wrap">
                <div class="ht-tabs">
                  <button class="ht-tab on" onclick="setHtMode(this,'rgb')">RGB</button>
                  <button class="ht-tab" onclick="setHtMode(this,'luma')">LUMA</button>
                </div>
                <canvas id="ht-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- PRO COLOR -->
        <div class="panel" id="panel-color">
          <div class="pnl-ttl" style="margin-bottom:12px">ã‚«ãƒ©ãƒ¼ã‚°ãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</div>
          <div id="sl-color"></div>
          <div class="sec">
            <div class="sec-hd"><div class="sec-ttl"><div class="sec-bar"></div><span>RGBã‚«ãƒ¼ãƒ–</span></div></div>
            <div class="sec-body">
              <div class="cv-wrap">
                <div class="cv-tabs">
                  <button class="cv-tab on" data-ch="L" onclick="setCvCh(this,'L')">LUMA</button>
                  <button class="cv-tab" data-ch="R" onclick="setCvCh(this,'R')">R</button>
                  <button class="cv-tab" data-ch="G" onclick="setCvCh(this,'G')">G</button>
                  <button class="cv-tab" data-ch="B" onclick="setCvCh(this,'B')">B</button>
                </div>
                <canvas id="cv-canvas"></canvas>
                <div style="font-size:8px;color:var(--t3);margin-top:6px">ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• Â· ã‚¿ãƒƒãƒ—ã§è¿½åŠ  Â· ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§å‰Šé™¤</div>
              </div>
            </div>
          </div>
          <div class="sec">
            <div class="sec-hd click" onclick="toggleSec(this)">
              <div class="sec-ttl"><div class="sec-bar"></div><span>HSLãƒŸã‚­ã‚µãƒ¼</span></div>
              <span class="sec-arr">â–¾</span>
            </div>
            <div class="sec-body"><div id="hsl-panel"></div></div>
          </div>
          <div class="sec closed">
            <div class="sec-hd click" onclick="toggleSec(this)">
              <div class="sec-ttl"><div class="sec-bar"></div><span>ã‚«ãƒ©ãƒ¼ãƒŸãƒƒã‚¯ã‚¹ (ä¸Šç´š)</span></div>
              <span class="sec-arr">â–¾</span>
            </div>
            <div class="sec-body"><div id="sl-adv"></div></div>
          </div>
        </div>

        <!-- PRO DETAIL -->
        <div class="panel" id="panel-detail">
          <div class="pnl-ttl" style="margin-bottom:12px">ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ãƒ»å…‰å­¦</div>
          <div id="sl-detail"></div>
        </div>

        <!-- PRO TRANSFORM -->
        <div class="panel" id="panel-xform">
          <div class="pnl-ttl" style="margin-bottom:12px">å›è»¢ãƒ»å¤‰å½¢</div>
          <div class="rot-grid">
            <button class="rot-btn" onclick="doRotate(-90)"><span class="ri">â†º</span>å·¦å›è»¢</button>
            <button class="rot-btn" onclick="doRotate(90)"><span class="ri">â†»</span>å³å›è»¢</button>
            <button class="rot-btn" onclick="doFlipH()"><span class="ri">â‡„</span>æ°´å¹³åè»¢</button>
            <button class="rot-btn" onclick="doFlipV()"><span class="ri">â‡…</span>å‚ç›´åè»¢</button>
          </div>
          <div id="sl-xform"></div>
        </div>

        <!-- CUT -->
        <div class="panel" id="panel-cut">
          <div class="pnl-ttl" style="margin-bottom:12px">ã‚«ãƒƒãƒˆãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ </div>
          <div style="font-size:9px;color:var(--t3);font-weight:700;letter-spacing:1.5px;margin-bottom:8px">åŸºæœ¬</div>
          <div class="crop-grid">
            <div class="crop-card on" onclick="pickCrop(this)"><div class="crop-ratio">1:1</div><div class="crop-nm">ã‚¹ã‚¯ã‚¨ã‚¢</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">4:3</div><div class="crop-nm">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">16:9</div><div class="crop-nm">ãƒ¯ã‚¤ãƒ‰</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">3:4</div><div class="crop-nm">ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">9:16</div><div class="crop-nm">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">FREE</div><div class="crop-nm">ã‚«ã‚¹ã‚¿ãƒ </div></div>
          </div>
          <div style="font-size:9px;color:var(--t3);font-weight:700;letter-spacing:1.5px;margin:10px 0 8px">ğŸ“¸ è¨¼æ˜å†™çœŸãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
          <div class="crop-grid">
            <div class="crop-card" onclick="pickCrop(this,30,40)"><div class="crop-ratio" style="font-size:11px">30Ã—40</div><div class="crop-nm">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</div></div>
            <div class="crop-card" onclick="pickCrop(this,35,45)"><div class="crop-ratio" style="font-size:11px">35Ã—45</div><div class="crop-nm">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼</div></div>
            <div class="crop-card" onclick="pickCrop(this,24,30)"><div class="crop-ratio" style="font-size:11px">24Ã—30</div><div class="crop-nm">å±¥æ­´æ›¸S</div></div>
            <div class="crop-card" onclick="pickCrop(this,40,50)"><div class="crop-ratio" style="font-size:11px">40Ã—50</div><div class="crop-nm">å±¥æ­´æ›¸L</div></div>
            <div class="crop-card" onclick="pickCrop(this,25,30)"><div class="crop-ratio" style="font-size:11px">25Ã—30</div><div class="crop-nm">é‹è»¢å…è¨±</div></div>
            <div class="crop-card" onclick="pickCrop(this,45,45)"><div class="crop-ratio" style="font-size:11px">45Ã—45</div><div class="crop-nm">ãƒ“ã‚¶ç”¨</div></div>
          </div>
          <div style="font-size:9px;color:var(--t3);font-weight:700;letter-spacing:1.5px;margin:10px 0 8px">ğŸ“® ãƒ—ãƒªãƒ³ãƒˆåˆ¤</div>
          <div class="crop-grid">
            <div class="crop-card" onclick="pickCrop(this,89,127)"><div class="crop-ratio" style="font-size:11px">Låˆ¤</div><div class="crop-nm">89Ã—127mm</div></div>
            <div class="crop-card" onclick="pickCrop(this,102,152)"><div class="crop-ratio" style="font-size:11px">2Låˆ¤</div><div class="crop-nm">102Ã—152mm</div></div>
            <div class="crop-card" onclick="pickCrop(this,62,99)"><div class="crop-ratio" style="font-size:11px">ãƒã‚§ã‚­</div><div class="crop-nm">62Ã—99mm</div></div>
            <div class="crop-card" onclick="pickCrop(this,100,148)"><div class="crop-ratio" style="font-size:11px">ã¯ãŒã</div><div class="crop-nm">100Ã—148mm</div></div>
          </div>
        </div>

        <!-- MOSAIC -->
        <div class="panel" id="panel-mosaic">
          <div class="pnl-ttl" style="margin-bottom:8px">ãƒ¢ã‚¶ã‚¤ã‚¯</div>
          <div data-i18n="mosaicDesc" style="font-size:11px;color:var(--t2);margin-bottom:14px">ãƒ¢ã‚¶ã‚¤ã‚¯ã®ã‚µã‚¤ã‚ºã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          <div class="mos-grid" id="mos-grid"></div>
          <button class="ghost" data-i18n="clearMosaic" style="width:100%" onclick="clearMosaic()">ãƒ¢ã‚¶ã‚¤ã‚¯ã‚’æ¶ˆã™</button>
        </div>

        <!-- SIZE -->
        <div class="panel" id="panel-size">
          <div class="pnl-ttl" style="margin-bottom:12px">å‡ºåŠ›ã‚µã‚¤ã‚º</div>
          <div class="res-row">
            <div class="res-iw"><div class="inp-lbl">æ¨ªå¹… px</div><input type="number" id="rw" value="1080" oninput="onResChange()"/></div>
            <div class="res-x">Ã—</div>
            <div class="res-iw"><div class="inp-lbl">ç¸¦å¹… px</div><input type="number" id="rh" value="1080" oninput="onResChange()"/></div>
          </div>
          <div class="divider"></div>
          <div id="rp-list"></div>
        </div>

        <!-- PRESET -->
        <div class="panel" id="panel-preset">
          <div class="pnl-hd">
            <div class="pnl-ttl">ãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
            <button class="solid" data-i18n-preset-save onclick="showPI()">ï¼‹ ä¿å­˜</button>
          </div>
          <div id="pi-box" style="display:none" class="pi-box">
            <div class="inp-lbl">ãƒ—ãƒªã‚»ãƒƒãƒˆå</div>
            <input type="text" id="pi-name" style="margin-bottom:9px"/>
            <div class="pi-btns">
              <button class="solid" data-i18n="save" style="flex:1" onclick="savePreset()">ä¿å­˜</button>
              <button class="ghost" data-i18n="cancel" style="flex:1" onclick="hidePI()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
          <div id="preset-list"></div>
        </div>

        <!-- INFO -->
        <div class="panel" id="panel-info">
          <div class="pnl-ttl" style="margin-bottom:12px">ç”»åƒæƒ…å ±</div>
          <div id="info-body">
            <div class="empty"><div class="e-ring"><div class="e-dot"></div></div><div class="e-ttl">ç”»åƒãªã—</div><div class="e-sub">ç”»åƒã‚’é–‹ãã¨æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div></div>
          </div>
        </div>

      </div><!-- /panel-wrap -->
    </div><!-- /editor-area -->

    <div id="bot">
      <button class="rst" data-i18n="reset" onclick="resetAdj()">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="exp-b" data-i18n="export" onclick="openModal()">æ›¸ãå‡ºã™</button>
    </div>
  </div><!-- /right-pane -->
</div><!-- /app -->

<!-- EXPORT MODAL -->
<div class="overlay" id="exp-modal">
  <div class="sheet">
    <div class="modal-ttl">æ›¸ãå‡ºã—è¨­å®š</div>
    <div class="fmt-grid">
      <div class="fmt-opt on" onclick="pickFmt(this,'jpg')"><div class="fmt-nm">JPEG</div><div class="fmt-sub">ãŠã™ã™ã‚ãƒ»é«˜ç”»è³ª</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'png')"><div class="fmt-nm">PNG</div><div class="fmt-sub">ãƒ­ã‚¹ãƒ¬ã‚¹</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'webp')"><div class="fmt-nm">WEBP</div><div class="fmt-sub">ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã„</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'transparent')"><div class="fmt-nm">PNGé€é</div><div class="fmt-sub">èƒŒæ™¯é€é</div></div>
    </div>
    <div class="modal-btns">
      <button class="ghost" data-i18n="cancel" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="solid" data-i18n="download" style="flex:2" onclick="doExport()">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div id="confirm">
  <div class="confirm-box">
    <div class="confirm-ico">âš ï¸</div>
    <div class="confirm-ttl">ç·¨é›†å†…å®¹ãŒæ¶ˆãˆã¾ã™</div>
    <div class="confirm-sub">æœªä¿å­˜ã®ç·¨é›†ãŒã‚ã‚Šã¾ã™ã€‚<br>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ</div>
    <div class="confirm-btns">
      <button class="c-no" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="c-ok" onclick="confirmGoHome()">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<canvas id="offscreen" style="display:none"></canvas>

<script>
(()=>{
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   i18n (minimal â€” all strings)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const T={
  ja:{
    sub:'ãƒ•ã‚©ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼',open:'é–‹ã',export:'æ›¸ãå‡ºã™',begin:'ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹',
    phTxt:'ã‚¿ãƒƒãƒ—ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦\nå†™çœŸã‚’é–‹ã',
    easy:'ã‹ã‚“ãŸã‚“',pro:'PRO',en:'EN',
    filterStr:'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¼·ã•',
    filterCats:{cheki:'ğŸ“· ãƒã‚§ã‚­ãƒ»ãƒ•ã‚£ãƒ«ãƒ ',white:'ğŸ¤ ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‰ãƒªãƒ¼ãƒ ',pink:'ğŸŒ¸ ãƒ”ãƒ³ã‚¯ç³»',airy:'âœ¨ ã‚¨ã‚¢ãƒªãƒ¼ãƒ»ãƒŠãƒãƒ¥ãƒ©ãƒ«',other:'ğŸ¨ ãã®ä»–'},
    easyLbls:{brightness:'æ˜ã‚‹ã•',contrast:'ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ',saturation:'è‰²ã®é®®ã‚„ã‹ã•',temperature:'è‰²æ¸©åº¦',fade:'ãµã‚“ã‚ã‚Šæ„Ÿ',sharpness:'ã‚·ãƒ£ãƒ¼ãƒ—',vignette:'å‘¨è¾ºæš—ã‚',grain:'ãƒ•ã‚£ãƒ«ãƒ æ„Ÿ'},
    easyDesc:{brightness:'å†™çœŸã‚’æ˜ã‚‹ããƒ»æš—ãã—ã¾ã™',contrast:'ãƒ¡ãƒªãƒãƒªã‚’ã¤ã‘ã¾ã™',saturation:'è‰²ã‚’é®®ã‚„ã‹ã«',temperature:'æš–ã‹ã„ãƒ»å†·ãŸã„é›°å›²æ°—ã«',fade:'ãµã‚ã£ã¨æ·¡ã„å°è±¡ã«',sharpness:'è¼ªéƒ­ã‚’ãã£ãã‚Š',vignette:'å‘¨å›²ã‚’æš—ãã—ã¦ä¸­å¿ƒã‚’ç›®ç«‹ãŸã›ã¾ã™',grain:'ãƒ•ã‚£ãƒ«ãƒ å†™çœŸã®ã‚ˆã†ãªè³ªæ„Ÿã«'},
    sl:{brightness:'æ˜ã‚‹ã•',contrast:'ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ',exposure:'éœ²å‡º',highlights:'ãƒã‚¤ãƒ©ã‚¤ãƒˆ',shadows:'ã‚·ãƒ£ãƒ‰ã‚¦',blacks:'é»’ãƒ¬ãƒ™ãƒ«',whites:'ç™½ãƒ¬ãƒ™ãƒ«',saturation:'å½©åº¦',vibrance:'è‡ªç„¶ãªå½©åº¦',hue:'è‰²ç›¸ã‚·ãƒ•ãƒˆ',temperature:'è‰²æ¸©åº¦',tint:'ãƒ†ã‚£ãƒ³ãƒˆ',sharpness:'ã‚·ãƒ£ãƒ¼ãƒ—',blur:'ã¼ã‹ã—',clarity:'æ˜ç­åº¦',vignette:'å‘¨è¾ºæ¸›å…‰',lens:'å‘¨è¾ºå…‰é‡è£œæ­£',chrAb:'è‰²åå·®',noise:'ãƒã‚¤ã‚º(è¼åº¦)',noiseC:'ãƒã‚¤ã‚º(è‰²)',grain:'ãƒ•ã‚£ãƒ«ãƒ ã‚°ãƒ¬ã‚¤ãƒ³',fade:'ãƒ•ã‚§ãƒ¼ãƒ‰',distortion:'æ­ªã¿è£œæ­£',angle:'å¾®èª¿æ•´è§’åº¦',perspH:'æ°´å¹³è£œæ­£',perspV:'å‚ç›´è£œæ­£',rr:'èµ¤â†’èµ¤',rg:'èµ¤â†’ç·‘',rb:'èµ¤â†’é’',gr:'ç·‘â†’èµ¤',gg:'ç·‘â†’ç·‘',gb:'ç·‘â†’é’',br:'é’â†’èµ¤',bg2:'é’â†’ç·‘',bb:'é’â†’é’'},
    rp:{SNS:'SNS',HD:'HD',Print:'å°åˆ·',Square:'ã‚¹ã‚¯ã‚¨ã‚¢'},
    mosaicDesc:'ãƒ¢ã‚¶ã‚¤ã‚¯ã®ã‚µã‚¤ã‚ºã‚’é¸æŠã—ã¦ãã ã•ã„',clearMosaic:'ãƒ¢ã‚¶ã‚¤ã‚¯ã‚’æ¶ˆã™',noImg:'ç”»åƒãªã—',noImgSub:'ç”»åƒã‚’é–‹ãã¨æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™',
    noPresets:'ãƒ—ãƒªã‚»ãƒƒãƒˆãªã—',noPresetsSub:'èª¿æ•´ã—ã¦ä¿å­˜ã—ã¾ã—ã‚‡ã†',
    builtin:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',myPresets:'ãƒã‚¤ãƒ—ãƒªã‚»ãƒƒãƒˆ',
    apply:'é©ç”¨',del:'âœ•',
    reset:'ãƒªã‚»ãƒƒãƒˆ',save:'ä¿å­˜',cancel:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',download:'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
    infoKeys:{file:'ãƒ•ã‚¡ã‚¤ãƒ«å',size:'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º',type:'å½¢å¼',w:'å…ƒã®å¹…',h:'å…ƒã®é«˜ã•',mp:'ãƒ¡ã‚¬ãƒ”ã‚¯ã‚»ãƒ«',ar:'ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”',outW:'å‡ºåŠ›å¹…',outH:'å‡ºåŠ›é«˜ã•'},
    techTitle:'ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è©³ç´°',adjTitle:'é©ç”¨ä¸­ã®èª¿æ•´',noneAdj:'ãªã—',
    confirmTitle:'ç·¨é›†å†…å®¹ãŒæ¶ˆãˆã¾ã™',confirmSub:'æœªä¿å­˜ã®ç·¨é›†ãŒã‚ã‚Šã¾ã™ã€‚\nãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ',confirmOk:'æˆ»ã‚‹',
  },
  en:{
    sub:'PHOTO EDITOR',open:'OPEN',export:'EXPORT',begin:'TAP TO BEGIN',
    phTxt:'Tap or drop to open\na photo',
    easy:'EASY',pro:'PRO',en:'æ—¥æœ¬èª',
    filterStr:'Filter Intensity',
    filterCats:{cheki:'ğŸ“· Cheki & Film',white:'ğŸ¤ White Dream',pink:'ğŸŒ¸ Pink',airy:'âœ¨ Airy & Natural',other:'ğŸ¨ Other'},
    easyLbls:{brightness:'Brightness',contrast:'Contrast',saturation:'Saturation',temperature:'Warmth',fade:'Fade',sharpness:'Sharpness',vignette:'Vignette',grain:'Film Grain'},
    easyDesc:{brightness:'Brighter or darker',contrast:'Add punch',saturation:'Vivid or muted',temperature:'Warm or cool',fade:'Soft dreamy look',sharpness:'Crisper edges',vignette:'Darken edges',grain:'Film-like texture'},
    sl:{brightness:'Brightness',contrast:'Contrast',exposure:'Exposure',highlights:'Highlights',shadows:'Shadows',blacks:'Blacks',whites:'Whites',saturation:'Saturation',vibrance:'Vibrance',hue:'Hue Shift',temperature:'Temperature',tint:'Tint',sharpness:'Sharpness',blur:'Blur',clarity:'Clarity',vignette:'Vignette',lens:'Lens Correction',chrAb:'Chromatic Ab.',noise:'Noise (Luma)',noiseC:'Noise (Chroma)',grain:'Film Grain',fade:'Fade',distortion:'Distortion',angle:'Fine Angle',perspH:'Perspective H',perspV:'Perspective V',rr:'Redâ†’Red',rg:'Redâ†’Green',rb:'Redâ†’Blue',gr:'Greenâ†’Red',gg:'Greenâ†’Green',gb:'Greenâ†’Blue',br:'Blueâ†’Red',bg2:'Blueâ†’Green',bb:'Blueâ†’Blue'},
    rp:{SNS:'SNS',HD:'HD',Print:'Print',Square:'Square'},
    mosaicDesc:'Select mosaic block size',clearMosaic:'Clear Mosaic',noImg:'No Image',noImgSub:'Open an image to view data',
    noPresets:'No Presets',noPresetsSub:'Adjust and save a look',
    builtin:'Default Filters',myPresets:'My Presets',
    apply:'APPLY',del:'âœ•',
    reset:'RESET',save:'SAVE',cancel:'CANCEL',download:'DOWNLOAD',
    infoKeys:{file:'Filename',size:'File Size',type:'Format',w:'Native W',h:'Native H',mp:'Megapixels',ar:'Aspect Ratio',outW:'Output W',outH:'Output H'},
    techTitle:'Technical Details',adjTitle:'Active Adjustments',noneAdj:'NONE',
    confirmTitle:'Unsaved Changes',confirmSub:'You have unsaved edits.\nGo back to home?',confirmOk:'Go Home',
  }
};
let L='ja';
function t(key,...path){let o=T[L];for(const k of[key,...path]){if(o==null)return key;o=o[k]}return o??T.en[key]??key}
function toggleLang(){L=L==='ja'?'en':'ja';applyLang()}
function applyLang(){
  document.getElementById('lang-btn').textContent=T[L].en;
  document.getElementById('mb-easy').textContent=T[L].easy;
  document.getElementById('mb-pro').textContent=T[L].pro;
  document.getElementById('open-btn').textContent=T[L].open;
  document.getElementById('exp-hbtn').textContent=T[L].export;
  document.getElementById('hdr-sub').textContent=T[L].sub;
  const sp_sub=document.getElementById('sp-sub');if(sp_sub)sp_sub.textContent=T[L].sub;
  const sp_cta_el=document.getElementById('sp-cta');if(sp_cta_el)sp_cta_el.textContent=T[L].begin;
  const ph_txt=document.getElementById('ph-txt');if(ph_txt)ph_txt.textContent=T[L].phTxt;
  // Update bottom bar buttons
  document.querySelectorAll('.rst').forEach(b=>b.textContent=T[L].reset);
  document.querySelectorAll('.exp-b').forEach(b=>b.textContent=T[L].export);
  // Update confirm dialog
  const cttl=document.querySelector('.confirm-ttl');if(cttl)cttl.textContent=T[L].confirmTitle;
  const csub=document.querySelector('.confirm-sub');if(csub)csub.textContent=T[L].confirmSub;
  const cok=document.querySelector('.c-ok');if(cok)cok.textContent=T[L].confirmOk;
  // Update static i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    if(T[L][key])el.textContent=T[L][key];
  });
  // Rebuild everything to apply language to all dynamic elements
  buildAll();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DEF={
  brightness:0,contrast:0,exposure:0,highlights:0,shadows:0,blacks:0,whites:0,
  saturation:0,vibrance:0,hue:0,temperature:0,tint:0,
  sharpness:0,blur:0,clarity:0,vignette:0,lens:0,chrAb:0,noise:0,noiseC:0,grain:0,fade:0,distortion:0,
  angle:0,perspH:0,perspV:0,
  rr:0,rg:0,rb:0,gr:0,gg:0,gb:0,br:0,bg2:0,bb:0,
};
const HSL_COLS=['Red','Orange','Yellow','Green','Aqua','Blue','Purple','Magenta'];
const HSL_DOTS=['#e02020','#f87020','#ddb800','#10a020','#00b8cc','#1060e0','#8820e0','#d010a0'];
HSL_COLS.forEach(c=>{DEF['hH_'+c]=0;DEF['hS_'+c]=0;DEF['hL_'+c]=0});

let adj={...DEF};
let rotDeg=0,fH=false,fV=false;
let rw=1080,rh=1080;
let srcImg=null,imgMeta=null;
let exportFmt='jpg';
let mosaicSize=0;
let filterIntensity=100;
let activeFilterId=null;
let isDirty=false;
let curMode='pro';
let curPanel='tone';
let htMode='rgb';
let cvCh='L';
let myPresets=JSON.parse(localStorage.getItem('lens_v9')||'[]');

const curves={
  L:[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]],
  R:[[0,0],[.5,.5],[1,1]],
  G:[[0,0],[.5,.5],[1,1]],
  B:[[0,0],[.5,.5],[1,1]],
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILT-IN FILTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FILTERS=[
  {id:'f1', icon:'ğŸŒ¸', name:'ãµã‚ãƒ”ãƒ³ã‚¯',nameEn:'Fluffy Pink',     adj:{brightness:8,contrast:-10,saturation:15,tint:20,temperature:15,fade:22,vignette:12,vibrance:10}},
  // White Dream series
  {id:'f3', icon:'ğŸ¤', name:'ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‰ãƒªãƒ¼ãƒ ',nameEn:'White Dream',adj:{brightness:20,contrast:-15,saturation:-20,temperature:-15,fade:30,vignette:5,highlights:20}},
  {id:'f3b',icon:'â˜ï¸', name:'ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ãƒ¯ã‚¤ãƒˆ',nameEn:'Cloud White',adj:{brightness:25,contrast:-20,saturation:-30,fade:40,vignette:3,highlights:25,whites:20}},
  {id:'f3c',icon:'ğŸ•Šï¸', name:'ã‚½ãƒ•ãƒˆãƒŸãƒ«ã‚¯',nameEn:'Soft Milk',    adj:{brightness:18,contrast:-22,saturation:-15,temperature:-8,fade:35,vignette:8,highlights:18,shadows:10}},
  {id:'f3d',icon:'ğŸ«§', name:'ãƒ”ãƒ¥ã‚¢ãƒ›ãƒ¯ã‚¤ãƒˆ',nameEn:'Pure White',  adj:{brightness:28,contrast:-28,saturation:-40,fade:45,vignette:0,highlights:30,whites:25,shadows:15}},
  {id:'f3e',icon:'ğŸŒ', name:'ãƒŸã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°',nameEn:'Mist Morning',adj:{brightness:15,contrast:-18,saturation:-10,temperature:-12,blur:2,fade:28,vignette:6,highlights:15}},
  // Pink series
  {id:'f8', icon:'ğŸ‘', name:'æ¡ƒè‰²ãƒˆãƒ¯ã‚¤ãƒ©ã‚¤ãƒˆ',nameEn:'Peach Twilight',adj:{brightness:12,saturation:25,temperature:25,tint:18,fade:18,vignette:20,vibrance:20}},
  {id:'f8b',icon:'ğŸŒ¹', name:'ãƒ­ãƒ¼ã‚ºã‚¯ã‚©ãƒ¼ãƒ„',nameEn:'Rose Quartz', adj:{brightness:10,contrast:-8,saturation:20,temperature:20,tint:25,fade:25,vignette:15,vibrance:18}},
  {id:'f8c',icon:'ğŸ€', name:'ãƒ™ãƒ“ãƒ¼ãƒ”ãƒ³ã‚¯',nameEn:'Baby Pink',    adj:{brightness:15,contrast:-15,saturation:10,temperature:18,tint:30,fade:32,vignette:10,vibrance:12,highlights:12}},
  {id:'f8d',icon:'ğŸŒ·', name:'ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—',nameEn:'Tulip',    adj:{brightness:8,contrast:-5,saturation:30,temperature:22,tint:15,fade:15,vignette:18,vibrance:25}},
  {id:'f8e',icon:'ğŸ’—', name:'ãƒ”ãƒ³ã‚¯ãƒ‰ãƒªãƒ¼ãƒ ',nameEn:'Pink Dream',  adj:{brightness:14,contrast:-12,saturation:18,temperature:15,tint:28,fade:30,vignette:12,vibrance:15,highlights:10}},
  {id:'f8f',icon:'ğŸ“', name:'ã‚¹ãƒˆãƒ­ãƒ™ãƒªãƒ¼',nameEn:'Strawberry',    adj:{brightness:6,contrast:5,saturation:35,temperature:18,tint:10,vignette:22,vibrance:30}},
  // Airy / Bright
  {id:'f4', icon:'âœ¨', name:'ã‚¨ã‚¢ãƒªãƒ¼',nameEn:'Airy',        adj:{brightness:18,contrast:-18,saturation:-5,fade:35,vignette:8,shadows:15,highlights:10}},
  {id:'f4b',icon:'ğŸŒ¤ï¸', name:'ã‚µãƒ‹ãƒ¼ã‚¨ã‚¢ãƒ¼',nameEn:'Sunny Air',    adj:{brightness:20,contrast:-14,saturation:5,temperature:12,fade:28,vignette:6,shadows:12,highlights:15}},
  // Golden / Warm
  {id:'f5', icon:'ğŸŠ', name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¢ãƒ¯ãƒ¼',nameEn:'Golden Hour',adj:{brightness:8,contrast:10,saturation:20,temperature:35,tint:8,vignette:25,fade:10}},
  {id:'f5b',icon:'ğŸŒ…', name:'ã‚µãƒ³ã‚»ãƒƒãƒˆ',nameEn:'Sunset',      adj:{brightness:5,contrast:15,saturation:25,temperature:40,tint:5,vignette:30,fade:8,vibrance:15}},
  // Cool / Blue
  {id:'f2', icon:'ğŸ’™', name:'ã‚¯ãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼',nameEn:'Cool Blue',    adj:{brightness:5,contrast:5,saturation:5,temperature:-30,tint:-10,fade:15,vignette:18,vibrance:8}},
  {id:'f2b',icon:'ğŸ§Š', name:'ã‚¢ã‚¤ã‚¹ãƒ–ãƒ«ãƒ¼',nameEn:'Ice Blue',    adj:{brightness:8,contrast:8,saturation:-10,temperature:-40,tint:-15,fade:20,vignette:22,vibrance:5}},
  // Film / Retro
  {id:'f9', icon:'â˜•', name:'ã‚«ãƒ•ã‚§ãƒ•ã‚£ãƒ«ãƒ ',nameEn:'Cafe Film',  adj:{brightness:-5,contrast:15,saturation:-10,temperature:20,grain:35,fade:20,vignette:35}},
  {id:'f9b',icon:'ğŸ“·', name:'ãƒã‚§ã‚­é¢¨',nameEn:'Cheki',        adj:{brightness:15,contrast:-20,saturation:-5,temperature:8,grain:25,fade:38,vignette:15,highlights:18,shadows:8}},
  {id:'f9c',icon:'ğŸï¸', name:'ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ãƒ ',nameEn:'Vintage Film',adj:{brightness:-8,contrast:20,saturation:-15,temperature:25,grain:45,fade:25,vignette:40,hue:5}},
  // B&W
  {id:'f6', icon:'ğŸ–¤', name:'ãƒ¢ãƒã‚¯ãƒ­',nameEn:'Monochrome',        adj:{saturation:-100,contrast:20,sharpness:20,vignette:30}},
  {id:'f6b',icon:'â¬œ', name:'ã‚½ãƒ•ãƒˆãƒ¢ãƒ',nameEn:'Soft Mono',      adj:{saturation:-100,contrast:5,brightness:12,fade:20,vignette:15}},
  // Nature / Green
  {id:'f7', icon:'ğŸŒ¿', name:'ãƒŠãƒãƒ¥ãƒ©ãƒ«ã‚°ãƒªãƒ¼ãƒ³',nameEn:'Natural Green',adj:{brightness:5,saturation:20,temperature:-5,clarity:10,vibrance:15,hue:8}},
  // Food
  {id:'f10',icon:'ğŸ½ï¸',name:'ãŠã„ã—ãã†',       adj:{brightness:10,contrast:18,saturation:30,temperature:18,vibrance:25,clarity:15,highlights:-10}},
  // Ocean
  {id:'f11',icon:'ğŸŒŠ', name:'ã‚ªãƒ¼ã‚·ãƒ£ãƒ³',nameEn:'Ocean',       adj:{brightness:8,saturation:22,temperature:-20,tint:-5,clarity:12,vibrance:20,vignette:15}},
  // Night
  {id:'f12',icon:'ğŸŒ™', name:'ãƒŠã‚¤ãƒˆãƒ ãƒ¼ãƒ‰',nameEn:'Night Mood',     adj:{brightness:-18,contrast:25,saturation:10,temperature:-10,vignette:45,clarity:8}},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildFilterGrid(){
  const el=document.getElementById('filter-grid');if(!el)return;
  // Add category headers
  const fcats=t('filterCats');
  const cats=[
    {label:fcats&&fcats.cheki?fcats.cheki:'ğŸ“· ãƒã‚§ã‚­ãƒ»ãƒ•ã‚£ãƒ«ãƒ ',ids:['f9b','f9','f9c']},
    {label:fcats&&fcats.white?fcats.white:'ğŸ¤ ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‰ãƒªãƒ¼ãƒ ',ids:['f3','f3b','f3c','f3d','f3e']},
    {label:fcats&&fcats.pink?fcats.pink:'ğŸŒ¸ ãƒ”ãƒ³ã‚¯ç³»',ids:['f1','f8','f8b','f8c','f8d','f8e','f8f']},
    {label:fcats&&fcats.airy?fcats.airy:'âœ¨ ã‚¨ã‚¢ãƒªãƒ¼ãƒ»ãƒŠãƒãƒ¥ãƒ©ãƒ«',ids:['f4','f4b','f7']},
    {label:fcats&&fcats.other?fcats.other:'ğŸ¨ ãã®ä»–',ids:['f5','f5b','f2','f2b','f6','f6b','f10','f11','f12']},
  ];
  let html='';
  cats.forEach(cat=>{
    const filters=cat.ids.map(id=>FILTERS.find(f=>f.id===id)).filter(Boolean);
    if(!filters.length)return;
    html+=`<div class="fg-cat">${cat.label}</div>`;
    html+=filters.map(f=>`
      <div class="fc${activeFilterId===f.id?' on':''}" onclick="applyFilter('${f.id}')">
        <div class="fi">${f.icon}</div>
        <div class="fn">${L==='en'&&f.nameEn?f.nameEn:f.name}</div>
      </div>`).join('');
  });
  el.innerHTML=html;
  const ir=document.getElementById('filt-intensity');if(!ir)return;
  ir.innerHTML=buildESliderHTML('__fi__','',0,100,filterIntensity);
  attachES(document.getElementById('ehit-__fi__'),'__fi__',0,100);
}

function applyFilter(id){
  activeFilterId=id;
  const f=FILTERS.find(x=>x.id===id);if(!f)return;
  const t2=filterIntensity/100;
  adj={...DEF};
  Object.entries(f.adj).forEach(([k,v])=>{if(k in adj)adj[k]=Math.round(v*t2)});
  isDirty=true;
  buildAllSliders();scheduleRender();buildFilterGrid();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EASY ADJUSTMENT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EASY_DEFS=[
  {key:'brightness',ico:'â˜€ï¸',min:-100,max:100},
  {key:'contrast',  ico:'â—‘', min:-100,max:100},
  {key:'saturation',ico:'ğŸ¨',min:-100,max:100},
  {key:'temperature',ico:'ğŸŒ¡ï¸',min:-100,max:100},
  {key:'fade',      ico:'ğŸŒ«ï¸',min:0,max:100},
  {key:'sharpness', ico:'ğŸ”',min:0,max:100},
  {key:'vignette',  ico:'â­•',min:0,max:100},
  {key:'grain',     ico:'ğŸï¸',min:0,max:100},
];

function buildEasyCards(){
  const el=document.getElementById('easy-cards');if(!el)return;
  el.innerHTML=EASY_DEFS.map(d=>`
    <div class="ec">
      <div class="ec-hd"><span class="ec-ico">${d.ico}</span><span class="ec-ttl">${t('easyLbls',d.key)}</span></div>
      <div class="ec-sub">${t('easyDesc',d.key)}</div>
      ${buildESliderHTML(d.key,d.key,d.min,d.max,adj[d.key]??0)}
    </div>`).join('');
  EASY_DEFS.forEach(d=>attachES(document.getElementById('ehit-'+d.key),d.key,d.min,d.max));
}

function buildESliderHTML(id,key,min,max,v){
  const p=((v-min)/(max-min))*100;
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  const label=key&&key!=='__fi__'?`<div class="es-top"><span class="es-lbl">${t('easyLbls',key)||''}</span><span class="es-val${v!==0?' nz':''}" id="ev-${id}">${v>0?'+'+v:v}</span></div>`:'<div class="es-top"><span></span><span class="es-val'+(v!==0?' nz':'')+'" id="ev-'+id+'">'+(v>0?'+'+v:v)+'</span></div>';
  return`${label}<div class="es-hit" id="ehit-${id}" data-min="${min}" data-max="${max}">
    <div class="es-bg">${hasMid?'<div class="es-mid"></div>':''}
      <div class="es-fill" id="ef-${id}" style="left:${fl};width:${fw}"></div>
      <div class="es-knob" id="ek-${id}" style="left:${p}%"></div>
    </div>
  </div>`;
}

function attachES(hit,id,min,max){
  if(!hit)return;
  let act=false;
  function calc(cx){const bg=hit.querySelector('.es-bg');const r=bg.getBoundingClientRect();return Math.round(min+Math.max(0,Math.min(1,(cx-r.left)/r.width))*(max-min))}
  function set(cx){
    const v=calc(cx);
    if(id==='__fi__'){filterIntensity=v;if(activeFilterId)applyFilter(activeFilterId);}
    else{if(adj[id]===v)return;adj[id]=v;isDirty=true;activeFilterId=null;syncSliderUI(id,v,min,max);scheduleRender();}
  }
  hit.addEventListener('pointerdown',e=>{act=true;hit.classList.add('drag');hit.setPointerCapture(e.pointerId);set(e.clientX);e.preventDefault()},{passive:false});
  hit.addEventListener('pointermove',e=>{if(!act)return;set(e.clientX)},{passive:true});
  const end=()=>{act=false;hit.classList.remove('drag')};
  hit.addEventListener('pointerup',end);hit.addEventListener('pointercancel',end);
}

function syncSliderUI(key,v,min,max){
  // Easy UI
  const p=((v-min)/(max-min))*100;
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  const ev=document.getElementById('ev-'+key);
  const ef=document.getElementById('ef-'+key);
  const ek=document.getElementById('ek-'+key);
  if(ev){ev.textContent=v>0?'+'+v:String(v);ev.className='es-val'+(v!==0?' nz':'');}
  if(ef){ef.style.left=fl;ef.style.width=fw;}
  if(ek)ek.style.left=p+'%';
  // Pro UI
  updateProSlider(key,v,min,max);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRO SLIDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GROUPS={
  tone:[
    ['brightness',-100,100],['contrast',-100,100],['exposure',-100,100],
    ['highlights',-100,100],['shadows',-100,100],['blacks',-100,100],['whites',-100,100]
  ],
  color:[
    ['saturation',-100,100],['vibrance',-100,100],['hue',-180,180],
    ['temperature',-100,100],['tint',-100,100]
  ],
  detail:[
    ['sharpness',0,100],['blur',0,30],['clarity',-100,100],['vignette',0,100],
    ['lens',-100,100],['chrAb',0,30],['noise',0,100],['noiseC',0,100],
    ['grain',0,100],['fade',0,100],['distortion',-50,50]
  ],
  xform:[['angle',-45,45],['perspH',-50,50],['perspV',-50,50]],
  adv:[
    ['rr',-100,100],['rg',-100,100],['rb',-100,100],
    ['gr',-100,100],['gg',-100,100],['gb',-100,100],
    ['br',-100,100],['bg2',-100,100],['bb',-100,100]
  ],
};

function pct(v,min,max){return((v-min)/(max-min))*100}
function fmtV(v){return v>0?'+'+v:String(v)}

function buildProSliderHTML(key,min,max){
  const v=adj[key]??0;const p=pct(v,min,max);
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  return`<div class="sl-row">
    <div class="sl-top">
      <span class="sl-lbl">${t('sl',key)}</span>
      <span class="sl-val${v!==0?' nz':''}" id="sv-${key}" onclick="openNI('${key}',${min},${max})">${fmtV(v)}
        <input class="sl-inp" id="si-${key}" type="number" min="${min}" max="${max}"
          onblur="closeNI('${key}',${min},${max})" onkeydown="niKey(event,'${key}',${min},${max})"/>
      </span>
    </div>
    <div class="sl-hit" id="sh-${key}" data-min="${min}" data-max="${max}">
      <div class="sl-bg">${hasMid?'<div class="sl-mid"></div>':''}
        <div class="sl-fill" id="sf-${key}" style="left:${fl};width:${fw}"></div>
        <div class="sl-knob" id="sk-${key}" style="left:${p}%"></div>
      </div>
    </div>
  </div>`;
}

function buildGroup(defs,cid){
  const el=document.getElementById(cid);if(!el)return;
  el.innerHTML=defs.map(([k,mn,mx])=>buildProSliderHTML(k,mn,mx)).join('');
  defs.forEach(([k,mn,mx])=>attachPS(document.getElementById('sh-'+k),k,mn,mx));
}

function buildAllSliders(){
  buildGroup(GROUPS.tone,'sl-tone');
  buildGroup(GROUPS.color,'sl-color');
  buildGroup(GROUPS.detail,'sl-detail');
  buildGroup(GROUPS.xform,'sl-xform');
  buildGroup(GROUPS.adv,'sl-adv');
  buildHSL();
  buildEasyCards();
  buildFilterGrid();
}

function attachPS(hit,key,min,max){
  if(!hit)return;
  let act=false;
  function calc(cx){const bg=hit.querySelector('.sl-bg');const r=bg.getBoundingClientRect();return Math.round(min+Math.max(0,Math.min(1,(cx-r.left)/r.width))*(max-min))}
  function set(cx){const v=calc(cx);if(adj[key]===v)return;adj[key]=v;isDirty=true;syncSliderUI(key,v,min,max);scheduleRender()}
  hit.addEventListener('pointerdown',e=>{act=true;hit.classList.add('drag');hit.setPointerCapture(e.pointerId);set(e.clientX);e.preventDefault()},{passive:false});
  hit.addEventListener('pointermove',e=>{if(!act)return;set(e.clientX)},{passive:true});
  const end=()=>{act=false;hit.classList.remove('drag')};
  hit.addEventListener('pointerup',end);hit.addEventListener('pointercancel',end);
}

function updateProSlider(key,v,min,max){
  const p=pct(v,min,max);
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  const sv=document.getElementById('sv-'+key);
  const sf=document.getElementById('sf-'+key);
  const sk=document.getElementById('sk-'+key);
  if(sv){sv.childNodes[0].textContent=fmtV(v);sv.className='sl-val'+(v!==0?' nz':'');}
  if(sf){sf.style.left=fl;sf.style.width=fw;}
  if(sk)sk.style.left=p+'%';
}

/* Num input */
function openNI(key,min,max){
  const sv=document.getElementById('sv-'+key);const si=document.getElementById('si-'+key);if(!sv||!si)return;
  si.value=adj[key];si.style.display='block';setTimeout(()=>{si.focus();si.select()},10);
}
function closeNI(key,min,max){
  const si=document.getElementById('si-'+key);if(!si)return;
  let v=parseInt(si.value,10);if(isNaN(v))v=adj[key];v=Math.max(min,Math.min(max,v));
  adj[key]=v;isDirty=true;syncSliderUI(key,v,min,max);scheduleRender();si.style.display='none';
}
function niKey(e,key,min,max){if(e.key==='Enter'||e.key==='Escape')closeNI(key,min,max)}

/* HSL */
function buildHSL(){
  const el=document.getElementById('hsl-panel');if(!el)return;
  const subs=[['H',-50,50],['S',-100,100],['L',-100,100]];
  el.innerHTML=HSL_COLS.map((c,i)=>`
    <div class="hsl-cr">
      <div class="hsl-hd"><div class="hsl-dot" style="background:${HSL_DOTS[i]}"></div><span class="hsl-nm">${c}</span></div>
      ${subs.map(([s,mn,mx])=>{
        const key='h'+s+'_'+c;const v=adj[key]??0;const p=pct(v,mn,mx);
        const fl=v>=0?'50%':p+'%';const fw=v>=0?(p-50)+'%':(50-p)+'%';
        return`<div class="hsl-sub">
          <span class="hsl-sl">${s}</span>
          <div class="sl-hit" id="sh-${key}" data-min="${mn}" data-max="${mx}">
            <div class="sl-bg"><div class="sl-mid"></div>
              <div class="sl-fill" id="sf-${key}" style="left:${fl};width:${fw}"></div>
              <div class="sl-knob" id="sk-${key}" style="left:${p}%"></div>
            </div>
          </div>
          <span class="hsl-v${v!==0?' nz':''}" id="sv-${key}">${fmtV(v)}</span>
        </div>`;
      }).join('')}
    </div>`).join('');
  HSL_COLS.forEach(c=>subs.forEach(([s,mn,mx])=>{
    const key='h'+s+'_'+c;attachPS(document.getElementById('sh-'+key),key,mn,mx);
  }));
}

function toggleSec(hd){hd.parentElement.classList.toggle('closed')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ENGINE  â† the core fix
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let rQueued=false;
function scheduleRender(){
  if(rQueued)return;
  rQueued=true;
  requestAnimationFrame(()=>{rQueued=false;renderCanvas()});
}

function renderCanvas(){
  if(!srcImg)return;
  const area=document.getElementById('preview-area');
  const cv=document.getElementById('prev-cv');
  const AW=area.clientWidth,AH=area.clientHeight;
  if(!AW||!AH)return;

  // Fit image into preview area
  const iw=srcImg.naturalWidth,ih=srcImg.naturalHeight;
  const sc=Math.min(AW/iw,AH/ih);
  const cw=Math.round(iw*sc),ch=Math.round(ih*sc);

  // Only resize if needed (avoid clearing on every call)
  if(cv.width!==cw||cv.height!==ch){cv.width=cw;cv.height=ch}
  cv.style.width=cw+'px';cv.style.height=ch+'px';

  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,cw,ch);

  // --- STEP 1: draw image with CSS filters ---
  ctx.save();
  ctx.translate(cw/2,ch/2);
  const ang=(rotDeg+adj.angle)*Math.PI/180;
  if(ang)ctx.rotate(ang);
  if(fH)ctx.scale(-1,1);
  if(fV)ctx.scale(1,-1);

  const bri=Math.max(0,1+adj.brightness/100);
  const con=Math.max(0.01,1+adj.contrast/100);
  const sat=Math.max(0,1+adj.saturation/100);
  const blrF=adj.blur>0?`blur(${(adj.blur*0.3).toFixed(2)}px)`:'';
  const hueF=adj.hue!==0?`hue-rotate(${adj.hue}deg)`:'';
  ctx.filter=[
    `brightness(${bri.toFixed(3)})`,
    `contrast(${con.toFixed(3)})`,
    `saturate(${sat.toFixed(3)})`,
    blrF,hueF
  ].filter(Boolean).join(' ');
  ctx.drawImage(srcImg,-cw/2,-ch/2,cw,ch);
  ctx.restore();
  ctx.filter='none';

  // --- STEP 2: pixel operations ---
  const needPx=adj.temperature||adj.tint||adj.highlights||adj.shadows||
                adj.blacks||adj.whites||adj.grain||adj.exposure;
  if(needPx){
    const id=ctx.getImageData(0,0,cw,ch);
    const d=id.data;
    // Pre-compute per-operation values
    const expF=Math.pow(2,adj.exposure/100);
    const hiB=adj.highlights/300;
    const shB=adj.shadows/300;
    const blkB=adj.blacks/200;
    const whtB=adj.whites/200;
    const tmpR=adj.temperature>0?adj.temperature*0.5:0;
    const tmpB=adj.temperature<0?-adj.temperature*0.5:0;
    const tintG=adj.tint>0?adj.tint*0.35:0;
    const tintRB=adj.tint<0?-adj.tint*0.35:0;

    for(let i=0;i<d.length;i+=4){
      let r=d[i],g=d[i+1],b=d[i+2];
      // Exposure
      if(adj.exposure){r=Math.min(255,r*expF);g=Math.min(255,g*expF);b=Math.min(255,b*expF);}
      // Temperature
      if(adj.temperature>0){r=Math.min(255,r+tmpR);b=Math.max(0,b-tmpB*0.3);}
      else if(adj.temperature<0){b=Math.min(255,b+tmpB);r=Math.max(0,r-tmpR*0.3);}
      // Tint
      if(adj.tint>0)g=Math.min(255,g+tintG);
      else if(adj.tint<0){r=Math.min(255,r+tintRB);b=Math.min(255,b+tintRB);}
      // Luma-based: highlights/shadows/blacks/whites
      const lum=(0.299*r+0.587*g+0.114*b)/255;
      if(adj.highlights&&lum>0.55){const s2=((lum-0.55)/0.45)*hiB;r=clamp(r+r*s2);g=clamp(g+g*s2);b=clamp(b+b*s2);}
      if(adj.shadows&&lum<0.45){const s2=((0.45-lum)/0.45)*shB;r=clamp(r+r*s2);g=clamp(g+g*s2);b=clamp(b+b*s2);}
      if(adj.whites&&lum>0.75){const s2=((lum-0.75)/0.25)*whtB;r=clamp(r+r*s2);g=clamp(g+g*s2);b=clamp(b+b*s2);}
      if(adj.blacks&&lum<0.25){const s2=((0.25-lum)/0.25)*blkB;r=clamp(r-r*s2);g=clamp(g-g*s2);b=clamp(b-b*s2);}
      // Grain
      if(adj.grain){const n=(Math.random()-.5)*adj.grain*0.7;r=clamp(r+n);g=clamp(g+n);b=clamp(b+n);}
      d[i]=r;d[i+1]=g;d[i+2]=b;
    }
    ctx.putImageData(id,0,0);
  }

  // --- STEP 3: mosaic ---
  if(mosaicSize>0){
    const ms=Math.max(2,Math.round(mosaicSize*sc/6));
    const tmp=ctx.createImageData(cw,ch);
    const src=ctx.getImageData(0,0,cw,ch).data;
    for(let y=0;y<ch;y+=ms){for(let x=0;x<cw;x+=ms){
      const bi=(y*cw+x)*4;
      const pr=src[bi],pg=src[bi+1],pb2=src[bi+2];
      for(let dy=0;dy<ms&&y+dy<ch;dy++)for(let dx=0;dx<ms&&x+dx<cw;dx++){
        const ti=((y+dy)*cw+(x+dx))*4;
        tmp.data[ti]=pr;tmp.data[ti+1]=pg;tmp.data[ti+2]=pb2;tmp.data[ti+3]=255;
      }
    }}
    ctx.putImageData(tmp,0,0);
  }

  // --- STEP 4: overlay effects ---
  if(adj.vignette>0){
    const vg=ctx.createRadialGradient(cw/2,ch/2,0,cw/2,ch/2,Math.hypot(cw,ch)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.65),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${(adj.vignette/100*0.88).toFixed(3)})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,cw,ch);
  }
  if(adj.fade>0){
    ctx.fillStyle=`rgba(255,255,255,${(adj.fade/100*0.4).toFixed(3)})`;
    ctx.fillRect(0,0,cw,ch);
  }

  // Exposure bar
  document.getElementById('exp-fill').style.width=(50+adj.exposure/2)+'%';

  // Update histogram lazily
  const hc=document.getElementById('ht-canvas');
  if(hc&&hc.getBoundingClientRect().height>0)
    requestAnimationFrame(drawHistogram);
}

function clamp(v){return Math.max(0,Math.min(255,v))}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTOGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setHtMode(btn,mode){
  htMode=mode;
  document.querySelectorAll('.ht-tab').forEach(b=>b.classList.toggle('on',b===btn));
  drawHistogram();
}
function drawHistogram(){
  const hc=document.getElementById('ht-canvas');if(!hc)return;
  const pv=document.getElementById('prev-cv');if(!pv||pv.style.display==='none')return;
  const dpr=window.devicePixelRatio||1;
  const rect=hc.getBoundingClientRect();
  const W=Math.round(rect.width*dpr)||400;const H=Math.round(rect.height*dpr)||160;
  if(hc.width!==W||hc.height!==H){hc.width=W;hc.height=H}
  const ctx=hc.getContext('2d');
  ctx.clearRect(0,0,W,H);ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,W,H);
  const pctx=pv.getContext('2d');
  const id=pctx.getImageData(0,0,pv.width,pv.height);const d=id.data;
  const bw=Math.ceil(W/256)+1;
  if(htMode==='rgb'){
    const rH=new Uint32Array(256),gH=new Uint32Array(256),bH=new Uint32Array(256);
    for(let i=0;i<d.length;i+=4){rH[d[i]]++;gH[d[i+1]]++;bH[d[i+2]]++;}
    let mx=0;for(let i=0;i<256;i++){if(rH[i]>mx)mx=rH[i];if(gH[i]>mx)mx=gH[i];if(bH[i]>mx)mx=bH[i];}
    [[rH,'rgba(200,50,50,.7)'],[gH,'rgba(50,190,80,.7)'],[bH,'rgba(60,110,220,.7)']].forEach(([h,col])=>{
      ctx.fillStyle=col;
      for(let i=0;i<256;i++){const bH2=Math.round((h[i]/mx)*(H-2));ctx.fillRect(Math.round(i/256*W),H-bH2,bw,bH2);}
    });
  }else{
    const lH=new Uint32Array(256);
    for(let i=0;i<d.length;i+=4)lH[Math.round(.299*d[i]+.587*d[i+1]+.114*d[i+2])]++;
    let mx=0;for(let i=0;i<256;i++)if(lH[i]>mx)mx=lH[i];
    ctx.fillStyle='rgba(200,200,200,.75)';
    for(let i=0;i<256;i++){const bH2=Math.round((lH[i]/mx)*(H-2));ctx.fillRect(Math.round(i/256*W),H-bH2,bw,bH2);}
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RGB CURVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setCvCh(btn,ch){
  cvCh=ch;
  document.querySelectorAll('.cv-tab').forEach(b=>b.classList.toggle('on',b===btn));
  drawCurve();
}
function drawCurve(){
  const cv=document.getElementById('cv-canvas');if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  const rect=cv.getBoundingClientRect();
  const W=Math.round(rect.width*dpr)||400;const H=Math.round(rect.height*dpr)||320;
  if(cv.width!==W||cv.height!==H){cv.width=W;cv.height=H}
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='#1e1e1e';ctx.lineWidth=dpr;
  for(let i=1;i<4;i++){
    const x=W*i/4,y=H*i/4;
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
  }
  ctx.strokeStyle='#282828';ctx.lineWidth=dpr;
  ctx.beginPath();ctx.moveTo(0,H);ctx.lineTo(W,0);ctx.stroke();
  const pts=curves[cvCh];
  const col={L:'#d0d0d0',R:'#cc3333',G:'#33aa44',B:'#3366cc'}[cvCh];
  ctx.strokeStyle=col;ctx.lineWidth=2*dpr;
  ctx.beginPath();
  pts.forEach(([x,y],i)=>{const px=x*W,py=(1-y)*H;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py)});
  ctx.stroke();
  pts.forEach(([x,y])=>{
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x*W,(1-y)*H,5*dpr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=1.5*dpr;ctx.stroke();
  });
}

(()=>{
  const cv=document.getElementById('cv-canvas');if(!cv)return;
  let drag=null;
  function toNorm(e){
    const r=cv.getBoundingClientRect();
    const cx=e.touches?e.touches[0].clientX:e.clientX;
    const cy=e.touches?e.touches[0].clientY:e.clientY;
    return[Math.max(0,Math.min(1,(cx-r.left)/r.width)),Math.max(0,Math.min(1,1-(cy-r.top)/r.height))];
  }
  function nearest([x,y]){
    let bi=null,bd=Infinity;
    curves[cvCh].forEach(([px,py],i)=>{const d=Math.hypot(px-x,py-y);if(d<bd){bd=d;bi=i}});
    return bd<0.09?bi:null;
  }
  cv.addEventListener('pointerdown',e=>{
    cv.setPointerCapture(e.pointerId);
    const nm=toNorm(e);let idx=nearest(nm);
    if(idx===null){
      curves[cvCh].push([...nm]);
      curves[cvCh].sort((a,b)=>a[0]-b[0]);
      idx=curves[cvCh].findIndex(([x,y])=>Math.abs(x-nm[0])<.001&&Math.abs(y-nm[1])<.001);
    }
    drag=idx;drawCurve();e.preventDefault();
  },{passive:false});
  cv.addEventListener('pointermove',e=>{
    if(drag===null)return;
    const nm=toNorm(e);
    curves[cvCh][drag]=[...nm];
    curves[cvCh].sort((a,b)=>a[0]-b[0]);
    drag=curves[cvCh].findIndex(([x,y])=>Math.abs(x-nm[0])<.001&&Math.abs(y-nm[1])<.001);
    drawCurve();
  },{passive:true});
  cv.addEventListener('pointerup',()=>{drag=null});
  cv.addEventListener('dblclick',e=>{
    const idx=nearest(toNorm(e));
    if(idx!==null&&curves[cvCh].length>2){curves[cvCh].splice(idx,1);drawCurve();scheduleRender()}
  });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE LOAD + DRAG & DROP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onPreviewClick(){if(!srcImg)triggerOpen()}
function triggerOpen(){document.getElementById('fi').click()}
function onFI(e){const f=e.target.files[0];if(f)loadFile(f);e.target.value=''}

function loadFile(f){
  if(!f||!f.type.startsWith('image/'))return;
  const url=URL.createObjectURL(f);
  const img=new Image();
  img.onload=()=>{
    srcImg=img;isDirty=false;
    const ph=document.getElementById('ph');
    ph.style.transition='opacity .3s';ph.style.opacity='0';
    setTimeout(()=>{ph.style.display='none'},300);
    const cv=document.getElementById('prev-cv');cv.style.display='block';
    const area=document.getElementById('preview-area');area.classList.add('has-img');
    document.getElementById('bot').style.display='flex';
    document.getElementById('exp-hbtn').style.display='';
    document.getElementById('checker').style.display='block';
    imgMeta={
      name:f.name,size:(f.size/1024).toFixed(1)+' KB',type:f.type,
      w:img.naturalWidth,h:img.naturalHeight,
      mp:((img.naturalWidth*img.naturalHeight)/1e6).toFixed(2),
      ar:(img.naturalWidth/img.naturalHeight).toFixed(3),
      totalPx:(img.naturalWidth*img.naturalHeight).toLocaleString()
    };
    rw=img.naturalWidth;rh=img.naturalHeight;
    document.getElementById('rw').value=rw;
    document.getElementById('rh').value=rh;
    // Render after a tick to ensure area has correct dimensions
    requestAnimationFrame(()=>requestAnimationFrame(()=>{scheduleRender();buildInfo();buildRes()}));
  };
  img.onerror=()=>URL.revokeObjectURL(url);
  img.src=url;
}

// Drag & Drop
const previewArea=document.getElementById('preview-area');
['dragenter','dragover'].forEach(ev=>{
  previewArea.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();previewArea.classList.add('dragover')});
});
['dragleave','dragend'].forEach(ev=>{
  previewArea.addEventListener(ev,e=>{e.preventDefault();previewArea.classList.remove('dragover')});
});
previewArea.addEventListener('drop',e=>{
  e.preventDefault();e.stopPropagation();
  previewArea.classList.remove('dragover');
  const f=e.dataTransfer.files[0];if(f)loadFile(f);
});
// Also whole window
window.addEventListener('dragover',e=>e.preventDefault());
window.addEventListener('drop',e=>{
  e.preventDefault();
  const f=e.dataTransfer.files[0];
  if(f&&f.type.startsWith('image/'))loadFile(f);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING + MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sw(id){
  curPanel=id;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('on',p.id==='panel-'+id));
  if(id==='color')requestAnimationFrame(drawCurve);
  if(id==='tone')requestAnimationFrame(drawHistogram);
}

function setMode(mode){
  curMode=mode;
  document.getElementById('mb-easy').classList.toggle('on',mode==='easy');
  document.getElementById('mb-pro').classList.toggle('on',mode==='pro');
  // Easy-only tabs: efilter, eadj
  // Pro-only tabs: tone, color, detail, xform, mosaic, size, info
  // Shared: cut, preset
  document.querySelectorAll('.tab').forEach(t=>{
    const m=t.dataset.m;
    t.style.display=(m===undefined||m===mode)?'':'none';
  });
  // Activate default tab for mode
  if(mode==='easy')sw('efilter');
  else sw('tone');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOSAIC, ROTATE, CROP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MOS_SIZES=[4,8,16,32,64];
function buildMosaicGrid(){
  const el=document.getElementById('mos-grid');if(!el)return;
  el.innerHTML=MOS_SIZES.map(s=>`
    <div class="mos-card${mosaicSize===s?' on':''}" onclick="setMosaic(${s})">
      <div class="mos-sz">${s}px</div>
      <div class="mos-lbl">${s<=4?'ç´°':s<=16?'ä¸­':'ç²—'}</div>
    </div>`).join('');
}
function setMosaic(s){mosaicSize=s;isDirty=true;buildMosaicGrid();scheduleRender()}
function clearMosaic(){mosaicSize=0;buildMosaicGrid();scheduleRender()}
function doRotate(d){rotDeg=(rotDeg+d+360)%360;isDirty=true;scheduleRender()}
function doFlipH(){fH=!fH;isDirty=true;scheduleRender()}
function doFlipV(){fV=!fV;isDirty=true;scheduleRender()}
function pickCrop(el){document.querySelectorAll('.crop-card').forEach(c=>c.classList.remove('on'));el.classList.add('on')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resetAdj(){
  adj={...DEF};rotDeg=0;fH=false;fV=false;mosaicSize=0;
  activeFilterId=null;filterIntensity=100;isDirty=false;
  curves.L=[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]];
  curves.R=[[0,0],[.5,.5],[1,1]];curves.G=[[0,0],[.5,.5],[1,1]];curves.B=[[0,0],[.5,.5],[1,1]];
  buildAll();scheduleRender();requestAnimationFrame(drawCurve);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESOLUTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RP=[
  {k:'rpIG',      label:'Instagram Square',     w:1080,h:1080, cat:'SNS'},
  {k:'rpIGP',     label:'Instagram Portrait',   w:1080,h:1350, cat:'SNS'},
  {k:'rpIGL',     label:'Instagram Landscape',  w:1080,h:566,  cat:'SNS'},
  {k:'rpSt',      label:'Story / Reel',          w:1080,h:1920, cat:'SNS'},
  {k:'rpX',       label:'X Post',               w:1200,h:675,  cat:'SNS'},
  {k:'rpXB',      label:'X Banner',             w:1500,h:500,  cat:'SNS'},
  {k:'rpFB',      label:'Facebook OG',          w:1200,h:630,  cat:'SNS'},
  {k:'rpYT',      label:'YouTube Thumbnail',    w:1280,h:720,  cat:'SNS'},
  {k:'rpTT',      label:'TikTok',               w:1080,h:1920, cat:'SNS'},
  {k:'rpHD',      label:'HD',                   w:1280,h:720,  cat:'HD'},
  {k:'rpFHD',     label:'Full HD',              w:1920,h:1080, cat:'HD'},
  {k:'rpQHD',     label:'2K QHD',               w:2560,h:1440, cat:'HD'},
  {k:'rp4K',      label:'4K UHD',               w:3840,h:2160, cat:'HD'},
  {k:'rp8K',      label:'8K',                   w:7680,h:4320, cat:'HD'},
  {k:'rpA4L',     label:'A4 æ¨ª',                w:3508,h:2480, cat:'Print'},
  {k:'rpA4P',     label:'A4 ç¸¦',                w:2480,h:3508, cat:'Print'},
  {k:'rpA3L',     label:'A3 æ¨ª',                w:4961,h:3508, cat:'Print'},
  {k:'rpA3P',     label:'A3 ç¸¦',                w:3508,h:4961, cat:'Print'},
  {k:'rpSq1',     label:'Square 1K',            w:1000,h:1000, cat:'Square'},
  {k:'rpSq2',     label:'Square 2K',            w:2000,h:2000, cat:'Square'},
  {k:'rpSq4',     label:'Square 4K',            w:4000,h:4000, cat:'Square'},
];

function buildRes(){
  const el=document.getElementById('rp-list');if(!el)return;
  const cats=[...new Set(RP.map(r=>r.cat))];
  el.innerHTML=cats.map(cat=>{
    const items=RP.filter(r=>r.cat===cat);
    return`<div class="rp-cat">${cat}</div>`+items.map(r=>`
      <div class="rp-item${rw===r.w&&rh===r.h?' on':''}" onclick="pickRP(this,${r.w},${r.h})">
        <span class="rp-nm">${r.label}</span><span class="rp-dim">${r.w}Ã—${r.h}</span>
      </div>`).join('');
  }).join('');
}
function pickRP(el,w,h){
  document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('on'));
  el.classList.add('on');rw=w;rh=h;
  document.getElementById('rw').value=w;document.getElementById('rh').value=h;buildInfo();
}
function onResChange(){
  rw=+document.getElementById('rw').value||1080;rh=+document.getElementById('rh').value||1080;
  document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('on'));buildInfo();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showPI(){document.getElementById('pi-box').style.display='block';setTimeout(()=>document.getElementById('pi-name').focus(),30)}
function hidePI(){document.getElementById('pi-box').style.display='none';document.getElementById('pi-name').value=''}
function savePreset(){
  const n=document.getElementById('pi-name').value.trim();if(!n)return;
  myPresets.push({id:Date.now(),name:n,adj:{...adj},curves:JSON.parse(JSON.stringify(curves)),rot:rotDeg,fH,fV});
  localStorage.setItem('lens_v9',JSON.stringify(myPresets));hidePI();buildPresets();
}
function delPreset(id){myPresets=myPresets.filter(p=>p.id!==id);localStorage.setItem('lens_v9',JSON.stringify(myPresets));buildPresets()}
function applyPreset(id){
  const bp=FILTERS.find(f=>f.id===id);
  if(bp){adj={...DEF,...bp.adj};isDirty=true;buildAll();scheduleRender();return}
  const p=myPresets.find(x=>x.id===id);if(!p)return;
  adj={...p.adj};if(p.curves)Object.assign(curves,JSON.parse(JSON.stringify(p.curves)));
  rotDeg=p.rot||0;fH=!!p.fH;fV=!!p.fV;isDirty=true;
  buildAll();scheduleRender();drawCurve();sw('tone');
}

function buildPresets(){
  const el=document.getElementById('preset-list');if(!el)return;
  let html=`<div class="pnl-ttl" style="margin-bottom:8px;font-size:7.5px">${t('builtin')}</div>`;
  html+=FILTERS.map(f=>`
    <div class="pc builtin">
      <div class="pc-info"><div class="pc-nm">${f.icon} ${f.name}</div></div>
      <button class="app-btn" onclick="applyPreset('${f.id}')">${t('apply')}</button>
    </div>`).join('');
  if(myPresets.length){
    html+=`<div class="pnl-ttl" style="margin-top:16px;margin-bottom:8px;font-size:7.5px">${t('myPresets')}</div>`;
    html+=myPresets.map(p=>{
      const meta=Object.entries(p.adj).filter(([,v])=>v!==0).slice(0,3).map(([k,v])=>`${k}:${v>0?'+':''}${v}`).join(' Â· ')||'DEFAULT';
      return`<div class="pc">
        <div class="pc-info"><div class="pc-nm">${p.name}</div><div class="pc-meta">${meta}</div></div>
        <button class="app-btn" onclick="applyPreset(${p.id})">${t('apply')}</button>
        <button class="del-btn" onclick="delPreset(${p.id})">${t('del')}</button>
      </div>`;
    }).join('');
  }else{
    html+=`<div class="empty" style="padding:20px 0"><div class="e-ring"><div class="e-dot"></div></div><div class="e-ttl">ãƒ—ãƒªã‚»ãƒƒãƒˆãªã—</div><div class="e-sub">èª¿æ•´ã—ã¦ä¿å­˜ã—ã¾ã—ã‚‡ã†</div></div>`;
  }
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INFO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleInfoSec(id){
  document.getElementById('ish-'+id).classList.toggle('op');
  document.getElementById('isb-'+id).classList.toggle('op');
}
function buildInfo(){
  const el=document.getElementById('info-body');if(!el||!imgMeta)return;
  const rows=[
    ['file',imgMeta.name],['size',imgMeta.size],['type',imgMeta.type],
    ['w',imgMeta.w+' px'],['h',imgMeta.h+' px'],
    ['mp',imgMeta.mp+' MP'],['ar',imgMeta.ar+' : 1'],
    ['outW',rw+' px'],['outH',rh+' px'],
  ];
  const active=Object.entries(adj).filter(([,v])=>v!==0);
  el.innerHTML=rows.map(([k,v])=>`<div class="info-r"><span class="info-k">${t('infoKeys',k)}</span><span class="info-v">${v}</span></div>`).join('')+
    `<div class="info-sec">
      <div class="info-sh" id="ish-tech" onclick="toggleInfoSec('tech')"><span class="info-st">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è©³ç´°</span><span class="info-ch">â–¾</span></div>
      <div class="info-sb" id="isb-tech">
        <div class="idr"><span class="idk">COLOR SPACE</span><span class="idv">sRGB</span></div>
        <div class="idr"><span class="idk">BIT DEPTH</span><span class="idv">8-bit</span></div>
        <div class="idr"><span class="idk">TOTAL PIXELS</span><span class="idv">${imgMeta.totalPx}</span></div>
        <div class="idr"><span class="idk">ROTATION</span><span class="idv">${rotDeg}Â°${fH?' FH':''}${fV?' FV':''}</span></div>
      </div>
    </div>
    <div class="info-sec">
      <div class="info-sh" id="ish-adj" onclick="toggleInfoSec('adj')"><span class="info-st">é©ç”¨ä¸­ã®èª¿æ•´</span><span class="info-ch">â–¾</span></div>
      <div class="info-sb" id="isb-adj">
        ${active.length?active.map(([k,v])=>`<div class="idr"><span class="idk">${k}</span><span class="idv r">${v>0?'+':''}${v}</span></div>`).join(''):`<div class="idr"><span class="idk">ãªã—</span></div>`}
      </div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(){if(!srcImg)return;document.getElementById('exp-modal').classList.add('op')}
function closeModal(){document.getElementById('exp-modal').classList.remove('op')}
function pickFmt(el,fmt){document.querySelectorAll('.fmt-opt').forEach(e=>e.classList.remove('on'));el.classList.add('on');exportFmt=fmt}
function doExport(){
  if(!srcImg)return;
  const cv=document.getElementById('offscreen');
  cv.width=rw;cv.height=rh;
  const ctx=cv.getContext('2d');
  const transp=exportFmt==='transparent';
  if(!transp){ctx.fillStyle='#fff';ctx.fillRect(0,0,rw,rh)}
  ctx.save();ctx.translate(rw/2,rh/2);
  const ang=(rotDeg+adj.angle)*Math.PI/180;if(ang)ctx.rotate(ang);
  if(fH)ctx.scale(-1,1);if(fV)ctx.scale(1,-1);
  const bri=Math.max(0,1+adj.brightness/100);
  const con=Math.max(0.01,1+adj.contrast/100);
  const sat=Math.max(0,1+adj.saturation/100);
  const blrF=adj.blur>0?`blur(${(adj.blur*0.3).toFixed(2)}px)`:'';
  const hueF=adj.hue!==0?`hue-rotate(${adj.hue}deg)`:'';
  ctx.filter=[`brightness(${bri})`,`contrast(${con})`,`saturate(${sat})`,blrF,hueF].filter(Boolean).join(' ');
  ctx.drawImage(srcImg,-rw/2,-rh/2,rw,rh);ctx.restore();ctx.filter='none';
  // Pixel ops
  const needPx=adj.temperature||adj.tint||adj.highlights||adj.shadows||adj.blacks||adj.whites||adj.grain||adj.exposure;
  if(needPx){
    const id=ctx.getImageData(0,0,rw,rh);const d=id.data;
    const expF=Math.pow(2,adj.exposure/100);
    const hiB=adj.highlights/300,shB=adj.shadows/300,blkB=adj.blacks/200,whtB=adj.whites/200;
    const tmpR=adj.temperature>0?adj.temperature*0.5:0,tmpB=adj.temperature<0?-adj.temperature*0.5:0;
    const tintG=adj.tint>0?adj.tint*0.35:0,tintRB=adj.tint<0?-adj.tint*0.35:0;
    for(let i=0;i<d.length;i+=4){
      let r=d[i],g=d[i+1],b=d[i+2];
      if(adj.exposure){r=clamp(r*expF);g=clamp(g*expF);b=clamp(b*expF)}
      if(adj.temperature>0){r=clamp(r+tmpR);b=Math.max(0,b-tmpB*0.3)}
      else if(adj.temperature<0){b=clamp(b+tmpB);r=Math.max(0,r-tmpR*0.3)}
      if(adj.tint>0)g=clamp(g+tintG);else if(adj.tint<0){r=clamp(r+tintRB);b=clamp(b+tintRB)}
      const lum=(0.299*r+0.587*g+0.114*b)/255;
      if(adj.highlights&&lum>0.55){const s2=((lum-0.55)/0.45)*hiB;r=clamp(r+r*s2);g=clamp(g+g*s2);b=clamp(b+b*s2)}
      if(adj.shadows&&lum<0.45){const s2=((0.45-lum)/0.45)*shB;r=clamp(r+r*s2);g=clamp(g+g*s2);b=clamp(b+b*s2)}
      if(adj.whites&&lum>0.75){const s2=((lum-0.75)/0.25)*whtB;r=clamp(r+r*s2);g=clamp(g+g*s2);b=clamp(b+b*s2)}
      if(adj.blacks&&lum<0.25){const s2=((0.25-lum)/0.25)*blkB;r=clamp(r-r*s2);g=clamp(g-g*s2);b=clamp(b-b*s2)}
      if(adj.grain){const n=(Math.random()-.5)*adj.grain*0.7;r=clamp(r+n);g=clamp(g+n);b=clamp(b+n)}
      d[i]=r;d[i+1]=g;d[i+2]=b;
    }
    ctx.putImageData(id,0,0);
  }
  if(mosaicSize>0){
    for(let y=0;y<rh;y+=mosaicSize)for(let x=0;x<rw;x+=mosaicSize){
      const px=ctx.getImageData(x,y,1,1).data;
      ctx.fillStyle=`rgb(${px[0]},${px[1]},${px[2]})`;ctx.fillRect(x,y,mosaicSize,mosaicSize);
    }
  }
  if(adj.vignette>0&&!transp){
    const vg=ctx.createRadialGradient(rw/2,rh/2,0,rw/2,rh/2,Math.hypot(rw,rh)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.65),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${adj.vignette/100*0.88})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,rw,rh);
  }
  if(adj.fade>0){ctx.fillStyle=`rgba(255,255,255,${adj.fade/100*0.4})`;ctx.fillRect(0,0,rw,rh)}
  const mime=transp||exportFmt==='png'?'image/png':exportFmt==='webp'?'image/webp':'image/jpeg';
  const ext=transp||exportFmt==='png'?'png':exportFmt==='webp'?'webp':'jpg';
  const a=document.createElement('a');
  a.download=`lens_${Date.now()}.${ext}`;
  a.href=cv.toDataURL(mime,mime==='image/jpeg'?.94:undefined);
  a.click();closeModal();isDirty=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME / CONFIRM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goHome(){
  if(!srcImg)return;
  if(isDirty){document.getElementById('confirm').classList.add('op');return}
  doGoHome();
}
function closeConfirm(){document.getElementById('confirm').classList.remove('op')}
function confirmGoHome(){closeConfirm();doGoHome()}
function doGoHome(){
  srcImg=null;isDirty=false;mosaicSize=0;activeFilterId=null;filterIntensity=100;
  adj={...DEF};rotDeg=0;fH=false;fV=false;
  const cv=document.getElementById('prev-cv');cv.style.display='none';
  const cv2=cv.getContext('2d');if(cv2)cv2.clearRect(0,0,cv.width,cv.height);
  const area=document.getElementById('preview-area');area.classList.remove('has-img');
  const ph=document.getElementById('ph');ph.style.display='';ph.style.opacity='1';ph.style.transition='';
  document.getElementById('checker').style.display='none';
  document.getElementById('bot').style.display='none';
  document.getElementById('exp-hbtn').style.display='none';
  buildAll();
  if(curMode==='easy')sw('efilter');else sw('tone');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLIT HANDLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(()=>{
  const handle=document.getElementById('split-handle');if(!handle)return;
  const app=document.getElementById('app');
  let dragging=false;
  handle.addEventListener('mousedown',e=>{dragging=true;handle.classList.add('drag');e.preventDefault()});
  document.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const r=app.getBoundingClientRect();
    const pct2=Math.max(20,Math.min(72,((e.clientX-r.left)/r.width)*100));
    document.documentElement.style.setProperty('--split',pct2+'%');
    if(srcImg)scheduleRender();
  });
  document.addEventListener('mouseup',()=>{dragging=false;handle.classList.remove('drag')});
  function posHandle(){
    const lp=document.getElementById('left-pane');
    if(!lp)return;
    const lr=lp.getBoundingClientRect();
    handle.style.left=(lr.right-4)+'px';
  }
  new ResizeObserver(posHandle).observe(document.getElementById('left-pane'));
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESIZE OBSERVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
new ResizeObserver(()=>{
  if(srcImg)scheduleRender();
  if(document.getElementById('panel-color').classList.contains('on'))requestAnimationFrame(drawCurve);
}).observe(document.getElementById('preview-area'));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('splash').addEventListener('click',()=>{
  const sp=document.getElementById('splash');
  sp.classList.add('out');
  setTimeout(()=>sp.remove(),550);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBALS EXPOSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Cheki quick apply */
function applyCheki(style){
  const styles={
    soft:{brightness:15,contrast:-20,saturation:-5,temperature:8,grain:25,fade:38,vignette:15,highlights:18,shadows:8},
    warm:{brightness:12,contrast:-15,saturation:5,temperature:20,grain:28,fade:32,vignette:18,highlights:15,shadows:10},
    cool:{brightness:12,contrast:-18,saturation:-8,temperature:-12,grain:22,fade:35,vignette:14,highlights:16,shadows:8},
  };
  const s=styles[style];if(!s)return;
  adj={...DEF,...s};isDirty=true;activeFilterId=null;
  buildAllSliders();scheduleRender();
}

Object.assign(window,{
  toggleLang,setMode,sw,triggerOpen,onFI,openModal,closeModal,pickFmt,doExport,
  resetAdj,setCvCh,toggleSec,doRotate,doFlipH,doFlipV,pickCrop,
  onResChange,pickRP,showPI,hidePI,savePreset,delPreset,applyPreset,
  toggleInfoSec,openNI,closeNI,niKey,
  goHome,closeConfirm,confirmGoHome,
  setMosaic,clearMosaic,setHtMode,applyFilter,onPreviewClick,applyCheki
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD ALL + BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildAll(){
  buildAllSliders();buildRes();buildPresets();buildMosaicGrid();
}
buildAll();
// Default: PRO mode, Japanese
setMode('pro');
// sw('tone') already called by setMode
})();
</script>
</body>
</html>
